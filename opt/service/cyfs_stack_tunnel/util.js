"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.UtilTool = void 0;
const base_1 = require("../../base");
const generator_1 = require("./generator");
const fs = __importStar(require("fs-extra"));
const path = __importStar(require("path"));
const crypto = __importStar(require("crypto"));
class UtilTool {
    constructor(_interface, logger) {
        this.m_logger = logger;
        this.m_interface = _interface;
    }
    async utilRequest(command) {
        if (!command.json.name) {
            return { err: base_1.ErrorCode.notFound };
        }
        switch (command.json.name) {
            case "createFile":
                {
                    return await this.createFile(command);
                }
                ;
            case "createDir":
                {
                    return await this.createDir(command);
                }
                ;
            case "md5":
                {
                    return await this.md5(command);
                }
                ;
            case "getIPInfo":
                {
                    return await this.getIPInfo(command);
                }
                ;
            case "uploadLog":
                {
                    return await this.uploadLog(command);
                }
                ;
            case "uploadCacheFile":
                {
                    return await this.uploadCacheFile(command);
                }
                ;
            case "getCachePath": {
                return await this.getCachePath(command);
            }
        }
        this.m_logger.info(`#### not found utilRequest req_path `);
        return { err: base_1.ErrorCode.notFound };
    }
    async _createFile(filePath, fileSize) {
        let same = new Buffer(generator_1.RandomGenerator.string(999983));
        if (fileSize > 90 * 1024 * 1024) {
            same = new Buffer(generator_1.RandomGenerator.string(10 * 999983));
        }
        let randBuffer = new Buffer('');
        while (fileSize > (same.length + 200)) {
            randBuffer = Buffer.concat([randBuffer, new Buffer(generator_1.RandomGenerator.string(100)), same, new Buffer(generator_1.RandomGenerator.string(100))]);
            await fs.appendFileSync(filePath, randBuffer);
            fileSize = fileSize - randBuffer.byteLength;
            this.m_logger.info(`add buffer ${randBuffer.length} `);
            await base_1.sleep(50);
        }
        await fs.appendFileSync(filePath, new Buffer(generator_1.RandomGenerator.string(fileSize)));
    }
    async _md5(filePath) {
        let fsHash = crypto.createHash('md5');
        let fileInfo = fs.readFileSync(filePath);
        fsHash.update(fileInfo);
        let md5 = fsHash.digest('hex');
        return md5;
    }
    async createFile(command) {
        if (!command.json.fileSize || !command.json.peerName) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let peer = this._peerCachePath(command.json.peerName);
        let fileName = `${generator_1.RandomGenerator.string(10)}.txt`;
        let fileSize = command.json.fileSize;
        let filePath = path.join(peer.cache_path.file_upload, `${fileName}`);
        //创建文件夹
        if (!fs.existsSync(peer.cache_path.file_upload)) {
            await fs.mkdirpSync(peer.cache_path.file_upload);
        }
        //生成文件
        await this._createFile(filePath, fileSize);
        let md5 = await this._md5(filePath);
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    fileName,
                    filePath,
                    md5
                },
                bytes: Buffer.from("")
            }
        };
    }
    _peerCachePath(peerName) {
        return {
            cache_path: {
                file_upload: path.join(this.m_logger.dir(), `../${peerName}_cache`, "file_upload"),
                file_download: path.join(this.m_logger.dir(), `../${peerName}_cache`, "file_download"),
                NamedObject: path.join(this.m_logger.dir(), `../${peerName}_cache`, "NamedObject")
            }
        };
    }
    async getCachePath(command) {
        if (!command.json.peerName) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let peer = this._peerCachePath(command.json.peerName);
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    cache_path: peer.cache_path,
                },
                bytes: Buffer.from("")
            }
        };
    }
    async createDir(command) {
        if (!command.json.peerName || !command.json.fileSize || !command.json.dirNumber || !command.json.fileNumber || !command.json.deep) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let peer = this._peerCachePath(command.json.peerName);
        let dirName = generator_1.RandomGenerator.string(10);
        let dirPath = path.join(peer.cache_path.file_upload, `${dirName}`);
        //创建文件夹
        if (!fs.existsSync(peer.cache_path.file_upload)) {
            await fs.mkdirpSync(peer.cache_path.file_upload);
        }
        await generator_1.RandomGenerator.createRandomDir(dirPath, command.json.dirNumber, command.json.fileNumber, command.json.fileSize, command.json.deep);
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    dirName,
                    dirPath,
                },
                bytes: Buffer.from("")
            }
        };
    }
    async md5(command) {
        if (!command.json.filePath) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let md5 = await this._md5(command.json.filePath);
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    md5,
                },
                bytes: Buffer.from("")
            }
        };
    }
    async getIPInfo(command) {
        var interfaces = require('os').networkInterfaces();
        this.m_logger.info(interfaces);
        var IPv4List = [];
        var IPv6List = [];
        for (var devName in interfaces) {
            var iface = interfaces[devName];
            for (var i = 0; i < iface.length; i++) {
                var alias = iface[i];
                if (alias.family == 'IPv4' && alias.address !== '127.0.0.1') { //&& !alias.internal
                    IPv4List.push(alias.address);
                }
                if (alias.family == 'IPv6' && alias.address !== '127.0.0.1') { //&& !alias.internal
                    IPv6List.push(alias.address);
                }
            }
        }
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    ipInfo: { IPv4: IPv4List, IPv6: IPv6List }
                },
                bytes: Buffer.from("")
            }
        };
    }
    async uploadLog(command) {
        this.m_logger.info(`command : ${JSON.stringify(command.json)}`);
        if (!command.json.logName) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let zip = await this.m_interface.zip(this.m_interface.getLogger().dir(), command.json.logName);
        let upload = await this.m_interface.uploadFile(zip.dstPath, "logs");
        this.m_logger.info(`upload log to server ,result = ${JSON.stringify(upload)}`);
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    upload,
                },
                bytes: Buffer.from("")
            }
        };
    }
    async uploadFile(command) {
        this.m_logger.info(`command : ${JSON.stringify(command.json)}`);
        if (!command.json.logName || !command.json.dirPath) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let zip = await this.m_interface.zip(command.json.dirPath, command.json.logName);
        let upload = await this.m_interface.uploadFile(zip.dstPath, "logs");
        this.m_logger.info(`upload log to server ,result = ${JSON.stringify(upload)}`);
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    upload,
                },
                bytes: Buffer.from("")
            }
        };
    }
    async uploadCacheFile(command) {
        if (!command.json.path || !command.json.logName) {
            this.m_logger.error(`error command : ${JSON.stringify(command.json)}`);
            return { err: base_1.ErrorCode.unknownCommand };
        }
        let zip = await this.m_interface.zip(command.json.path, command.json.logName);
        let upload = await this.m_interface.uploadFile(zip.dstPath, "logs");
        return {
            err: base_1.ErrorCode.succ, resp: {
                json: {
                    upload,
                },
                bytes: Buffer.from("")
            }
        };
    }
}
exports.UtilTool = UtilTool;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlLXRlc3Rlci1hcHAvc2VydmljZS9jeWZzX3N0YWNrX3R1bm5lbC91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxQ0FBdUc7QUFDdkcsMkNBQTZDO0FBRzdDLDZDQUErQjtBQUMvQiwyQ0FBNkI7QUFDN0IsK0NBQWlDO0FBR2pDLE1BQWEsUUFBUTtJQUdqQixZQUFZLFVBQWtDLEVBQUUsTUFBYztRQUMxRCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQztRQUN2QixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQztJQUNsQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFzQjtRQUNwQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDcEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLFFBQVEsRUFBRSxDQUFBO1NBQ3JDO1FBQ0QsUUFBUSxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUN2QixLQUFLLFlBQVk7Z0JBQUU7b0JBQ2YsT0FBTyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3pDO2dCQUFBLENBQUM7WUFDRixLQUFLLFdBQVc7Z0JBQUU7b0JBQ2QsT0FBTyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3hDO2dCQUFBLENBQUM7WUFDRixLQUFLLEtBQUs7Z0JBQUU7b0JBQ1IsT0FBTyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ2xDO2dCQUFBLENBQUM7WUFDRixLQUFLLFdBQVc7Z0JBQUU7b0JBQ2QsT0FBTyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3hDO2dCQUFBLENBQUM7WUFDRixLQUFLLFdBQVc7Z0JBQUU7b0JBQ2QsT0FBTyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3hDO2dCQUFBLENBQUM7WUFDRixLQUFLLGlCQUFpQjtnQkFBRTtvQkFDcEIsT0FBTyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQzlDO2dCQUFBLENBQUM7WUFDRixLQUFLLGNBQWMsQ0FBQyxDQUFDO2dCQUNqQixPQUFPLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUMzQztTQUNKO1FBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsc0NBQXNDLENBQUMsQ0FBQTtRQUMxRCxPQUFPLEVBQUUsR0FBRyxFQUFFLGdCQUFTLENBQUMsUUFBUSxFQUFFLENBQUE7SUFDdEMsQ0FBQztJQUNELEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBZ0IsRUFBRSxRQUFnQjtRQUNoRCxJQUFJLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQywyQkFBZSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ3JELElBQUksUUFBUSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxFQUFFO1lBQzdCLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQywyQkFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQTtTQUN6RDtRQUNELElBQUksVUFBVSxHQUFHLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hDLE9BQU8sUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsRUFBRTtZQUNuQyxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLE1BQU0sQ0FBQywyQkFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLE1BQU0sQ0FBQywyQkFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqSSxNQUFNLEVBQUUsQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1lBQzdDLFFBQVEsR0FBRyxRQUFRLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQztZQUM1QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1lBQ3RELE1BQU0sWUFBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ25CO1FBQ0QsTUFBTSxFQUFFLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLE1BQU0sQ0FBQywyQkFBZSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDbkYsQ0FBQztJQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBZ0I7UUFDdkIsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNyQyxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBRSxDQUFBO1FBQ3pDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDdkIsSUFBSSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUM5QixPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFDRCxLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXNCO1FBQ25DLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2xELElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLG1CQUFtQixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLGNBQWMsRUFBRSxDQUFBO1NBQzNDO1FBQ0QsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3JELElBQUksUUFBUSxHQUFHLEdBQUcsMkJBQWUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQTtRQUNsRCxJQUFJLFFBQVEsR0FBVyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVMsQ0FBQztRQUM5QyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLEdBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQTtRQUNwRSxPQUFPO1FBQ1AsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUM3QyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNwRDtRQUNELE1BQU07UUFFTixNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLElBQUksR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNwQyxPQUFPO1lBQ0gsR0FBRyxFQUFFLGdCQUFTLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtnQkFDdkIsSUFBSSxFQUFFO29CQUNGLFFBQVE7b0JBQ1IsUUFBUTtvQkFDUixHQUFHO2lCQUNOO2dCQUNELEtBQUssRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUN6QjtTQUNKLENBQUE7SUFDTCxDQUFDO0lBQ0QsY0FBYyxDQUFDLFFBQWdCO1FBQzNCLE9BQU87WUFDSCxVQUFVLEVBQUU7Z0JBQ1IsV0FBVyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxNQUFNLFFBQVEsUUFBUSxFQUFFLGFBQWEsQ0FBQztnQkFDbEYsYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxNQUFNLFFBQVEsUUFBUSxFQUFFLGVBQWUsQ0FBQztnQkFDdEYsV0FBVyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxNQUFNLFFBQVEsUUFBUSxFQUFFLGFBQWEsQ0FBQzthQUNyRjtTQUNKLENBQUE7SUFDTCxDQUFDO0lBQ0QsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFzQjtRQUNyQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDeEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsbUJBQW1CLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUN0RSxPQUFPLEVBQUUsR0FBRyxFQUFFLGdCQUFTLENBQUMsY0FBYyxFQUFFLENBQUE7U0FDM0M7UUFDRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDckQsT0FBTztZQUNILEdBQUcsRUFBRSxnQkFBUyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUU7Z0JBQ3ZCLElBQUksRUFBRTtvQkFDRixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7aUJBQzlCO2dCQUNELEtBQUssRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUN6QjtTQUNKLENBQUE7SUFDTCxDQUFDO0lBQ0QsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFzQjtRQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUMvSCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3RFLE9BQU8sRUFBRSxHQUFHLEVBQUUsZ0JBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtTQUMzQztRQUNELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUNyRCxJQUFJLE9BQU8sR0FBRywyQkFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6QyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUMsQ0FBQTtRQUNsRSxPQUFPO1FBQ1AsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUM3QyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNwRDtRQUNELE1BQU0sMkJBQWUsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUksT0FBTztZQUNILEdBQUcsRUFBRSxnQkFBUyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUU7Z0JBQ3ZCLElBQUksRUFBRTtvQkFDRixPQUFPO29CQUNQLE9BQU87aUJBQ1Y7Z0JBQ0QsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2FBQ3pCO1NBQ0osQ0FBQTtJQUNMLENBQUM7SUFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQXNCO1FBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3RFLE9BQU8sRUFBRSxHQUFHLEVBQUUsZ0JBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtTQUMzQztRQUNELElBQUksR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pELE9BQU87WUFDSCxHQUFHLEVBQUUsZ0JBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO2dCQUN2QixJQUFJLEVBQUU7b0JBQ0YsR0FBRztpQkFDTjtnQkFDRCxLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7YUFDekI7U0FDSixDQUFBO0lBQ0wsQ0FBQztJQUNELEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBc0I7UUFDbEMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDOUIsSUFBSSxRQUFRLEdBQWtCLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLFFBQVEsR0FBa0IsRUFBRSxDQUFBO1FBQ2hDLEtBQUssSUFBSSxPQUFPLElBQUksVUFBVSxFQUFFO1lBQzVCLElBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkMsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEtBQUssV0FBVyxFQUFFLEVBQUUsb0JBQW9CO29CQUMvRSxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDaEM7Z0JBQ0QsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLFdBQVcsRUFBRSxFQUFFLG9CQUFvQjtvQkFDL0UsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ2hDO2FBQ0o7U0FDSjtRQUNELE9BQU87WUFDSCxHQUFHLEVBQUUsZ0JBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO2dCQUN2QixJQUFJLEVBQUU7b0JBQ0YsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO2lCQUM3QztnQkFDRCxLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7YUFDekI7U0FDSixDQUFBO0lBQ0wsQ0FBQztJQUNELEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBc0I7UUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDL0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLG1CQUFtQixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLGNBQWMsRUFBRSxDQUFBO1NBQzNDO1FBRUQsSUFBSSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDOUYsSUFBSSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUM5RSxPQUFPO1lBQ0gsR0FBRyxFQUFFLGdCQUFTLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtnQkFDdkIsSUFBSSxFQUFFO29CQUNGLE1BQU07aUJBQ1Q7Z0JBQ0QsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2FBQ3pCO1NBQ0osQ0FBQTtJQUNMLENBQUM7SUFDRCxLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXNCO1FBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQy9ELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2hELElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLG1CQUFtQixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLGNBQWMsRUFBRSxDQUFBO1NBQzNDO1FBRUQsSUFBSSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2hGLElBQUksTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDOUUsT0FBTztZQUNILEdBQUcsRUFBRSxnQkFBUyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUU7Z0JBQ3ZCLElBQUksRUFBRTtvQkFDRixNQUFNO2lCQUNUO2dCQUNELEtBQUssRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUN6QjtTQUNKLENBQUE7SUFDTCxDQUFDO0lBQ0QsS0FBSyxDQUFDLGVBQWUsQ0FBQyxPQUFzQjtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUM3QyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3RFLE9BQU8sRUFBRSxHQUFHLEVBQUUsZ0JBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtTQUMzQztRQUNELElBQUksR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUM3RSxJQUFJLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDckUsT0FBTztZQUNILEdBQUcsRUFBRSxnQkFBUyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUU7Z0JBQ3ZCLElBQUksRUFBRTtvQkFDRixNQUFNO2lCQUNUO2dCQUNELEtBQUssRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUN6QjtTQUNKLENBQUE7SUFDTCxDQUFDO0NBQ0o7QUF0T0QsNEJBc09DIiwiZmlsZSI6InNlcnZpY2UvY3lmc19zdGFja190dW5uZWwvdXRpbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVycm9yQ29kZSwgTmFtZXNwYWNlLCBCdWZmZXJXcml0ZXIsIFNlcnZpY2VDbGllbnRJbnRlcmZhY2UsIExvZ2dlciwgc2xlZXAgfSBmcm9tICcuLi8uLi9iYXNlJztcclxuaW1wb3J0IHsgUmFuZG9tR2VuZXJhdG9yIH0gZnJvbSBcIi4vZ2VuZXJhdG9yXCJcclxuaW1wb3J0IHsgQmR0THBjLCBCZHRMcGNDb21tYW5kLCBCZHRMcGNSZXNwIH0gZnJvbSAnLi9scGMnO1xyXG5cclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgVXRpbFRvb2wge1xyXG4gICAgcHJpdmF0ZSBtX2ludGVyZmFjZTogU2VydmljZUNsaWVudEludGVyZmFjZVxyXG4gICAgcHJpdmF0ZSBtX2xvZ2dlcjogTG9nZ2VyO1xyXG4gICAgY29uc3RydWN0b3IoX2ludGVyZmFjZTogU2VydmljZUNsaWVudEludGVyZmFjZSwgbG9nZ2VyOiBMb2dnZXIpIHtcclxuICAgICAgICB0aGlzLm1fbG9nZ2VyID0gbG9nZ2VyO1xyXG4gICAgICAgIHRoaXMubV9pbnRlcmZhY2UgPSBfaW50ZXJmYWNlO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHV0aWxSZXF1ZXN0KGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICBpZiAoIWNvbW1hbmQuanNvbi5uYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLm5vdEZvdW5kIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgc3dpdGNoIChjb21tYW5kLmpzb24ubmFtZSkge1xyXG4gICAgICAgICAgICBjYXNlIFwiY3JlYXRlRmlsZVwiOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5jcmVhdGVGaWxlKGNvbW1hbmQpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYXNlIFwiY3JlYXRlRGlyXCI6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNyZWF0ZURpcihjb21tYW5kKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSBcIm1kNVwiOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5tZDUoY29tbWFuZCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNhc2UgXCJnZXRJUEluZm9cIjoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0SVBJbmZvKGNvbW1hbmQpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYXNlIFwidXBsb2FkTG9nXCI6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVwbG9hZExvZyhjb21tYW5kKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSBcInVwbG9hZENhY2hlRmlsZVwiOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy51cGxvYWRDYWNoZUZpbGUoY29tbWFuZCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNhc2UgXCJnZXRDYWNoZVBhdGhcIjoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Q2FjaGVQYXRoKGNvbW1hbmQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubV9sb2dnZXIuaW5mbyhgIyMjIyBub3QgZm91bmQgdXRpbFJlcXVlc3QgcmVxX3BhdGggYClcclxuICAgICAgICByZXR1cm4geyBlcnI6IEVycm9yQ29kZS5ub3RGb3VuZCB9XHJcbiAgICB9XHJcbiAgICBhc3luYyBfY3JlYXRlRmlsZShmaWxlUGF0aDogc3RyaW5nLCBmaWxlU2l6ZTogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IHNhbWUgPSBuZXcgQnVmZmVyKFJhbmRvbUdlbmVyYXRvci5zdHJpbmcoOTk5OTgzKSlcclxuICAgICAgICBpZiAoZmlsZVNpemUgPiA5MCAqIDEwMjQgKiAxMDI0KSB7XHJcbiAgICAgICAgICAgIHNhbWUgPSBuZXcgQnVmZmVyKFJhbmRvbUdlbmVyYXRvci5zdHJpbmcoMTAgKiA5OTk5ODMpKVxyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcmFuZEJ1ZmZlciA9IG5ldyBCdWZmZXIoJycpO1xyXG4gICAgICAgIHdoaWxlIChmaWxlU2l6ZSA+IChzYW1lLmxlbmd0aCArIDIwMCkpIHtcclxuICAgICAgICAgICAgcmFuZEJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW3JhbmRCdWZmZXIsIG5ldyBCdWZmZXIoUmFuZG9tR2VuZXJhdG9yLnN0cmluZygxMDApKSwgc2FtZSwgbmV3IEJ1ZmZlcihSYW5kb21HZW5lcmF0b3Iuc3RyaW5nKDEwMCkpXSk7XHJcbiAgICAgICAgICAgIGF3YWl0IGZzLmFwcGVuZEZpbGVTeW5jKGZpbGVQYXRoLCByYW5kQnVmZmVyKVxyXG4gICAgICAgICAgICBmaWxlU2l6ZSA9IGZpbGVTaXplIC0gcmFuZEJ1ZmZlci5ieXRlTGVuZ3RoO1xyXG4gICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmluZm8oYGFkZCBidWZmZXIgJHtyYW5kQnVmZmVyLmxlbmd0aH0gYClcclxuICAgICAgICAgICAgYXdhaXQgc2xlZXAoNTApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhd2FpdCBmcy5hcHBlbmRGaWxlU3luYyhmaWxlUGF0aCwgbmV3IEJ1ZmZlcihSYW5kb21HZW5lcmF0b3Iuc3RyaW5nKGZpbGVTaXplKSkpXHJcbiAgICB9XHJcbiAgICBhc3luYyBfbWQ1KGZpbGVQYXRoOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgZnNIYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ21kNScpXHJcbiAgICAgICAgbGV0IGZpbGVJbmZvID0gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLClcclxuICAgICAgICBmc0hhc2gudXBkYXRlKGZpbGVJbmZvKVxyXG4gICAgICAgIGxldCBtZDUgPSBmc0hhc2guZGlnZXN0KCdoZXgnKVxyXG4gICAgICAgIHJldHVybiBtZDU7XHJcbiAgICB9XHJcbiAgICBhc3luYyBjcmVhdGVGaWxlKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICBpZiAoIWNvbW1hbmQuanNvbi5maWxlU2l6ZSB8fCAhY29tbWFuZC5qc29uLnBlZXJOYW1lKSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9sb2dnZXIuZXJyb3IoYGVycm9yIGNvbW1hbmQgOiAke0pTT04uc3RyaW5naWZ5KGNvbW1hbmQuanNvbil9YClcclxuICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBFcnJvckNvZGUudW5rbm93bkNvbW1hbmQgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcGVlciA9IHRoaXMuX3BlZXJDYWNoZVBhdGgoY29tbWFuZC5qc29uLnBlZXJOYW1lKVxyXG4gICAgICAgIGxldCBmaWxlTmFtZSA9IGAke1JhbmRvbUdlbmVyYXRvci5zdHJpbmcoMTApfS50eHRgXHJcbiAgICAgICAgbGV0IGZpbGVTaXplOiBudW1iZXIgPSBjb21tYW5kLmpzb24uZmlsZVNpemUhO1xyXG4gICAgICAgIGxldCBmaWxlUGF0aCA9IHBhdGguam9pbihwZWVyLmNhY2hlX3BhdGguZmlsZV91cGxvYWQsIGAke2ZpbGVOYW1lfWApXHJcbiAgICAgICAgLy/liJvlu7rmlofku7blpLlcclxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMocGVlci5jYWNoZV9wYXRoLmZpbGVfdXBsb2FkKSkge1xyXG4gICAgICAgICAgICBhd2FpdCBmcy5ta2RpcnBTeW5jKHBlZXIuY2FjaGVfcGF0aC5maWxlX3VwbG9hZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8v55Sf5oiQ5paH5Lu2XHJcblxyXG4gICAgICAgIGF3YWl0IHRoaXMuX2NyZWF0ZUZpbGUoZmlsZVBhdGgsIGZpbGVTaXplKTtcclxuICAgICAgICBsZXQgbWQ1ID0gYXdhaXQgdGhpcy5fbWQ1KGZpbGVQYXRoKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBlcnI6IEVycm9yQ29kZS5zdWNjLCByZXNwOiB7XHJcbiAgICAgICAgICAgICAgICBqc29uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZVBhdGgsXHJcbiAgICAgICAgICAgICAgICAgICAgbWQ1XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgYnl0ZXM6IEJ1ZmZlci5mcm9tKFwiXCIpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBfcGVlckNhY2hlUGF0aChwZWVyTmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgY2FjaGVfcGF0aDoge1xyXG4gICAgICAgICAgICAgICAgZmlsZV91cGxvYWQ6IHBhdGguam9pbih0aGlzLm1fbG9nZ2VyLmRpcigpLCBgLi4vJHtwZWVyTmFtZX1fY2FjaGVgLCBcImZpbGVfdXBsb2FkXCIpLFxyXG4gICAgICAgICAgICAgICAgZmlsZV9kb3dubG9hZDogcGF0aC5qb2luKHRoaXMubV9sb2dnZXIuZGlyKCksIGAuLi8ke3BlZXJOYW1lfV9jYWNoZWAsIFwiZmlsZV9kb3dubG9hZFwiKSxcclxuICAgICAgICAgICAgICAgIE5hbWVkT2JqZWN0OiBwYXRoLmpvaW4odGhpcy5tX2xvZ2dlci5kaXIoKSwgYC4uLyR7cGVlck5hbWV9X2NhY2hlYCwgXCJOYW1lZE9iamVjdFwiKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXN5bmMgZ2V0Q2FjaGVQYXRoKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICBpZiAoIWNvbW1hbmQuanNvbi5wZWVyTmFtZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBlcnJvciBjb21tYW5kIDogJHtKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pfWApXHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLnVua25vd25Db21tYW5kIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHBlZXIgPSB0aGlzLl9wZWVyQ2FjaGVQYXRoKGNvbW1hbmQuanNvbi5wZWVyTmFtZSlcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBlcnI6IEVycm9yQ29kZS5zdWNjLCByZXNwOiB7XHJcbiAgICAgICAgICAgICAgICBqc29uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVfcGF0aDogcGVlci5jYWNoZV9wYXRoLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGJ5dGVzOiBCdWZmZXIuZnJvbShcIlwiKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXN5bmMgY3JlYXRlRGlyKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICBpZiAoIWNvbW1hbmQuanNvbi5wZWVyTmFtZSB8fCAhY29tbWFuZC5qc29uLmZpbGVTaXplIHx8ICFjb21tYW5kLmpzb24uZGlyTnVtYmVyIHx8ICFjb21tYW5kLmpzb24uZmlsZU51bWJlciB8fCAhY29tbWFuZC5qc29uLmRlZXApIHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgZXJyb3IgY29tbWFuZCA6ICR7SlNPTi5zdHJpbmdpZnkoY29tbWFuZC5qc29uKX1gKVxyXG4gICAgICAgICAgICByZXR1cm4geyBlcnI6IEVycm9yQ29kZS51bmtub3duQ29tbWFuZCB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBwZWVyID0gdGhpcy5fcGVlckNhY2hlUGF0aChjb21tYW5kLmpzb24ucGVlck5hbWUpXHJcbiAgICAgICAgbGV0IGRpck5hbWUgPSBSYW5kb21HZW5lcmF0b3Iuc3RyaW5nKDEwKTtcclxuICAgICAgICBsZXQgZGlyUGF0aCA9IHBhdGguam9pbihwZWVyLmNhY2hlX3BhdGguZmlsZV91cGxvYWQsIGAke2Rpck5hbWV9YClcclxuICAgICAgICAvL+WIm+W7uuaWh+S7tuWkuVxyXG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhwZWVyLmNhY2hlX3BhdGguZmlsZV91cGxvYWQpKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGZzLm1rZGlycFN5bmMocGVlci5jYWNoZV9wYXRoLmZpbGVfdXBsb2FkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgUmFuZG9tR2VuZXJhdG9yLmNyZWF0ZVJhbmRvbURpcihkaXJQYXRoLCBjb21tYW5kLmpzb24uZGlyTnVtYmVyLCBjb21tYW5kLmpzb24uZmlsZU51bWJlciwgY29tbWFuZC5qc29uLmZpbGVTaXplLCBjb21tYW5kLmpzb24uZGVlcCk7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZXJyOiBFcnJvckNvZGUuc3VjYywgcmVzcDoge1xyXG4gICAgICAgICAgICAgICAganNvbjoge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpck5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgZGlyUGF0aCxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBieXRlczogQnVmZmVyLmZyb20oXCJcIilcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGFzeW5jIG1kNShjb21tYW5kOiBCZHRMcGNDb21tYW5kKTogUHJvbWlzZTxCZHRMcGNSZXNwPiB7XHJcbiAgICAgICAgaWYgKCFjb21tYW5kLmpzb24uZmlsZVBhdGgpIHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgZXJyb3IgY29tbWFuZCA6ICR7SlNPTi5zdHJpbmdpZnkoY29tbWFuZC5qc29uKX1gKVxyXG4gICAgICAgICAgICByZXR1cm4geyBlcnI6IEVycm9yQ29kZS51bmtub3duQ29tbWFuZCB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBtZDUgPSBhd2FpdCB0aGlzLl9tZDUoY29tbWFuZC5qc29uLmZpbGVQYXRoKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBlcnI6IEVycm9yQ29kZS5zdWNjLCByZXNwOiB7XHJcbiAgICAgICAgICAgICAgICBqc29uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWQ1LFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGJ5dGVzOiBCdWZmZXIuZnJvbShcIlwiKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXN5bmMgZ2V0SVBJbmZvKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICB2YXIgaW50ZXJmYWNlcyA9IHJlcXVpcmUoJ29zJykubmV0d29ya0ludGVyZmFjZXMoKTtcclxuICAgICAgICB0aGlzLm1fbG9nZ2VyLmluZm8oaW50ZXJmYWNlcylcclxuICAgICAgICB2YXIgSVB2NExpc3Q6IEFycmF5PHN0cmluZz4gPSBbXVxyXG4gICAgICAgIHZhciBJUHY2TGlzdDogQXJyYXk8c3RyaW5nPiA9IFtdXHJcbiAgICAgICAgZm9yICh2YXIgZGV2TmFtZSBpbiBpbnRlcmZhY2VzKSB7XHJcbiAgICAgICAgICAgIHZhciBpZmFjZSA9IGludGVyZmFjZXNbZGV2TmFtZV07XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWZhY2UubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBhbGlhcyA9IGlmYWNlW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFsaWFzLmZhbWlseSA9PSAnSVB2NCcgJiYgYWxpYXMuYWRkcmVzcyAhPT0gJzEyNy4wLjAuMScpIHsgLy8mJiAhYWxpYXMuaW50ZXJuYWxcclxuICAgICAgICAgICAgICAgICAgICBJUHY0TGlzdC5wdXNoKGFsaWFzLmFkZHJlc3MpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGFsaWFzLmZhbWlseSA9PSAnSVB2NicgJiYgYWxpYXMuYWRkcmVzcyAhPT0gJzEyNy4wLjAuMScpIHsgLy8mJiAhYWxpYXMuaW50ZXJuYWxcclxuICAgICAgICAgICAgICAgICAgICBJUHY2TGlzdC5wdXNoKGFsaWFzLmFkZHJlc3MpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGVycjogRXJyb3JDb2RlLnN1Y2MsIHJlc3A6IHtcclxuICAgICAgICAgICAgICAgIGpzb246IHtcclxuICAgICAgICAgICAgICAgICAgICBpcEluZm86IHsgSVB2NDogSVB2NExpc3QsIElQdjY6IElQdjZMaXN0IH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBieXRlczogQnVmZmVyLmZyb20oXCJcIilcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGFzeW5jIHVwbG9hZExvZyhjb21tYW5kOiBCZHRMcGNDb21tYW5kKTogUHJvbWlzZTxCZHRMcGNSZXNwPiB7XHJcbiAgICAgICAgdGhpcy5tX2xvZ2dlci5pbmZvKGBjb21tYW5kIDogJHtKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pfWApXHJcbiAgICAgICAgaWYgKCFjb21tYW5kLmpzb24ubG9nTmFtZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBlcnJvciBjb21tYW5kIDogJHtKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pfWApXHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLnVua25vd25Db21tYW5kIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB6aXAgPSBhd2FpdCB0aGlzLm1faW50ZXJmYWNlLnppcCh0aGlzLm1faW50ZXJmYWNlLmdldExvZ2dlcigpLmRpcigpLCBjb21tYW5kLmpzb24ubG9nTmFtZSlcclxuICAgICAgICBsZXQgdXBsb2FkID0gYXdhaXQgdGhpcy5tX2ludGVyZmFjZS51cGxvYWRGaWxlKHppcC5kc3RQYXRoISwgXCJsb2dzXCIpO1xyXG4gICAgICAgIHRoaXMubV9sb2dnZXIuaW5mbyhgdXBsb2FkIGxvZyB0byBzZXJ2ZXIgLHJlc3VsdCA9ICR7SlNPTi5zdHJpbmdpZnkodXBsb2FkKX1gKVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGVycjogRXJyb3JDb2RlLnN1Y2MsIHJlc3A6IHtcclxuICAgICAgICAgICAgICAgIGpzb246IHtcclxuICAgICAgICAgICAgICAgICAgICB1cGxvYWQsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgYnl0ZXM6IEJ1ZmZlci5mcm9tKFwiXCIpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBhc3luYyB1cGxvYWRGaWxlKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICB0aGlzLm1fbG9nZ2VyLmluZm8oYGNvbW1hbmQgOiAke0pTT04uc3RyaW5naWZ5KGNvbW1hbmQuanNvbil9YClcclxuICAgICAgICBpZiAoIWNvbW1hbmQuanNvbi5sb2dOYW1lIHx8ICFjb21tYW5kLmpzb24uZGlyUGF0aCkge1xyXG4gICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBlcnJvciBjb21tYW5kIDogJHtKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pfWApXHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLnVua25vd25Db21tYW5kIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB6aXAgPSBhd2FpdCB0aGlzLm1faW50ZXJmYWNlLnppcChjb21tYW5kLmpzb24uZGlyUGF0aCwgY29tbWFuZC5qc29uLmxvZ05hbWUpXHJcbiAgICAgICAgbGV0IHVwbG9hZCA9IGF3YWl0IHRoaXMubV9pbnRlcmZhY2UudXBsb2FkRmlsZSh6aXAuZHN0UGF0aCEsIFwibG9nc1wiKTtcclxuICAgICAgICB0aGlzLm1fbG9nZ2VyLmluZm8oYHVwbG9hZCBsb2cgdG8gc2VydmVyICxyZXN1bHQgPSAke0pTT04uc3RyaW5naWZ5KHVwbG9hZCl9YClcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBlcnI6IEVycm9yQ29kZS5zdWNjLCByZXNwOiB7XHJcbiAgICAgICAgICAgICAgICBqc29uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGJ5dGVzOiBCdWZmZXIuZnJvbShcIlwiKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXN5bmMgdXBsb2FkQ2FjaGVGaWxlKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPEJkdExwY1Jlc3A+IHtcclxuICAgICAgICBpZiAoIWNvbW1hbmQuanNvbi5wYXRoIHx8ICFjb21tYW5kLmpzb24ubG9nTmFtZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBlcnJvciBjb21tYW5kIDogJHtKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pfWApXHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLnVua25vd25Db21tYW5kIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHppcCA9IGF3YWl0IHRoaXMubV9pbnRlcmZhY2UuemlwKGNvbW1hbmQuanNvbi5wYXRoLCBjb21tYW5kLmpzb24ubG9nTmFtZSlcclxuICAgICAgICBsZXQgdXBsb2FkID0gYXdhaXQgdGhpcy5tX2ludGVyZmFjZS51cGxvYWRGaWxlKHppcC5kc3RQYXRoISwgXCJsb2dzXCIpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGVycjogRXJyb3JDb2RlLnN1Y2MsIHJlc3A6IHtcclxuICAgICAgICAgICAgICAgIGpzb246IHtcclxuICAgICAgICAgICAgICAgICAgICB1cGxvYWQsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgYnl0ZXM6IEJ1ZmZlci5mcm9tKFwiXCIpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19
