"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BdtLpc = void 0;
const base_1 = require("../../base");
const events_1 = require("events");
class BdtLpc extends events_1.EventEmitter {
    constructor(options) {
        super();
        this.m_version = 1;
        this.m_cmd_seq = 0;
        this.m_bQueue = false;
        this.m_logger = options.logger;
        this.m_sendCaches = [];
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    once(event, listener) {
        super.once(event, listener);
        return this;
    }
    set id(s) {
        this.m_id = s;
    }
    initFromListener(socket) {
        this.m_socket = socket;
        this._initSocket();
        return base_1.ErrorCode.succ;
    }
    _next_cmd_seq() {
        return this.m_cmd_seq++;
    }
    send(command) {
        command.seq = this._next_cmd_seq();
        this.m_logger.debug(`bdtlpc send command to bdt.exe, seq=${command.seq}, name=${command.json.name}`);
        let info = this._encodeMsg(command);
        if (info.err) {
            this.m_logger.error(`bdtlpc send command to bdt.exe failed,for encode failed, err=${info.err}}`);
            return info.err;
        }
        return this._send(info.buffer);
    }
    async wait_resp(command) {
        let err = this.send(command);
        if (err !== base_1.ErrorCode.succ) {
            return { err };
        }
        return await new Promise((v) => {
            let onFunc = (lpc, resp) => {
                if (resp.json.name !== "ping" && resp.seq === command.seq) {
                    lpc.removeListener('command', onFunc);
                    v({ err: base_1.ErrorCode.succ, resp });
                }
            };
            this.on('command', onFunc);
        });
    }
    _send(buff) {
        if (this.m_bQueue) {
            this.m_sendCaches.push(buff);
            return base_1.ErrorCode.succ;
        }
        try {
            this.m_bQueue = !this.m_socket.write(buff);
            return base_1.ErrorCode.succ;
        }
        catch (e) {
            this.m_logger.error(`bdtlpc send failed, error=${e}, s=${this.m_id}`);
            return base_1.ErrorCode.fail;
        }
    }
    _initSocket() {
        this.m_socket.on('drain', () => {
            if (this.m_sendCaches.length) {
                let buff = Buffer.concat(this.m_sendCaches);
                this.m_sendCaches = [];
                this.m_bQueue = !this.m_socket.write(buff);
            }
            else {
                this.m_bQueue = false;
            }
        });
        this.m_socket.on('data', (data) => {
            if (this.m_recvCache) {
                this.m_recvCache = Buffer.concat([this.m_recvCache, data]);
            }
            else {
                this.m_recvCache = data;
            }
            //2 = length(2)
            while (this.m_recvCache && this.m_recvCache.length > 2) {
                let msgInfo = this._decodeMsg();
                if (msgInfo.err) {
                    this.m_logger.error(`bdtlpc decode failed, err=${msgInfo.err}`);
                    if (msgInfo.err !== base_1.ErrorCode.noMoreData) {
                        this.m_recvCache = Buffer.from('');
                    }
                    break;
                }
                this.emit('command', this, msgInfo.command);
            }
        });
        this.m_socket.on('error', (err) => {
            this.emit('error', this, base_1.ErrorCode.fail);
        });
        this.m_socket.on('close', (had_error) => {
            this.m_logger.error(`bdtlpc socket close ${had_error}`);
            this.emit('close', this, had_error);
        });
    }
    _decodeMsg() {
        try {
            let decodeOffset = 0;
            if (this.m_recvCache.length < 4) {
                this.m_logger.error(`not get length when decode for no more data, length=${this.m_recvCache.length}, need=${4 + decodeOffset}`);
                return { err: base_1.ErrorCode.noMoreData };
            }
            let length = this.m_recvCache.readUInt32LE(decodeOffset);
            decodeOffset += 4;
            if (this.m_recvCache.length < 4 + length) {
                this.m_logger.error(`not get length when decode for no more data, length=${this.m_recvCache.length}, need=${4 + decodeOffset}`);
                return { err: base_1.ErrorCode.noMoreData };
            }
            let seq = this.m_recvCache.readUInt32LE(decodeOffset);
            decodeOffset += 4;
            let bytesLength = this.m_recvCache.readUInt32LE(decodeOffset);
            decodeOffset += 4;
            let bytes = Buffer.from('');
            if (bytesLength) {
                bytes = this.m_recvCache.slice(decodeOffset, decodeOffset + bytesLength);
                decodeOffset += bytesLength;
            }
            let jsonLength = length - 8 - bytesLength;
            let jsonBuffer = this.m_recvCache.slice(decodeOffset, decodeOffset + jsonLength);
            decodeOffset += jsonLength;
            this.m_recvCache = this.m_recvCache.slice(decodeOffset);
            //this.m_logger.debug(`-----------------${jsonBuffer.toString('utf-8')}, decodeOffset=${decodeOffset}, length=${this.m_recvCache!.length}`);
            let json = JSON.parse(jsonBuffer.toString('utf-8'));
            let command = { seq, bytes, json };
            return { err: base_1.ErrorCode.succ, command };
        }
        catch (e) {
            this.m_logger.error(`bdtlpc decode msg exception, e=${e}`);
            return { err: base_1.ErrorCode.exception };
        }
    }
    _encodeMsg(command) {
        try {
            let buffer = new Buffer(4 /*total*/ + 4 /*seq*/ + 4 /*bytes length*/);
            let jsonStr = JSON.stringify(command.json);
            let total = 4 + 4 + command.bytes.length + jsonStr.length;
            buffer.writeUInt32LE(total, 0);
            buffer.writeUInt32LE(command.seq, 4);
            buffer.writeUInt32LE(command.bytes.length, 8);
            buffer = Buffer.concat([buffer, command.bytes, Buffer.from(jsonStr)]);
            return { err: base_1.ErrorCode.succ, buffer };
        }
        catch (e) {
            this.m_logger.error(`bdtlpc encode msg exception, e=${e}`);
            return { err: base_1.ErrorCode.exception };
        }
    }
}
exports.BdtLpc = BdtLpc;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlLXRlc3Rlci1hcHAvc2VydmljZS9jeWZzX3N0YWNrX3R1bm5lbC9scGMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQStDO0FBRS9DLG1DQUFzQztBQWlCdEMsTUFBYSxNQUFPLFNBQVEscUJBQVk7SUEwQnBDLFlBQVksT0FBc0I7UUFDOUIsS0FBSyxFQUFFLENBQUM7UUF0QkosY0FBUyxHQUFXLENBQUMsQ0FBQztRQUd0QixjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBb0IxQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDL0IsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQWxCRCxFQUFFLENBQUMsS0FBYSxFQUFFLFFBQWtDO1FBQ2hELEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFLRCxJQUFJLENBQUMsS0FBYSxFQUFFLFFBQWtDO1FBQ2xELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFTRCxJQUFJLEVBQUUsQ0FBQyxDQUFTO1FBQ1osSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVELGdCQUFnQixDQUFDLE1BQWtCO1FBQy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixPQUFPLGdCQUFTLENBQUMsSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFFTyxhQUFhO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLENBQUMsT0FBc0I7UUFD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U0FBUyxHQUFHLENBQUMsQ0FBQSxPQUFPLEdBQUcsQ0FBQyxDQUFBLGdCQUFnQixDQUFDLENBQUM7WUFFM0UsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsSUFBSSxLQUFLLEdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBRTlDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQztTQUMxQztRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDM0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ3ZDO0lBQ0wsQ0FBQztDQUNKO0FBak1ELHdCQWlNQyIsImZpbGUiOiJzZXJ2aWNlL2N5ZnNfc3RhY2tfdHVubmVsL2xwYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVycm9yQ29kZSwgTG9nZ2VyIH0gZnJvbSAnLi4vLi4vYmFzZSc7XHJcbmltcG9ydCAqIGFzIG5ldCBmcm9tICduZXQnO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xyXG5cclxuZXhwb3J0IHR5cGUgQmR0THBjQ29tbWFuZCA9IHtcclxuICAgIHNlcT86IG51bWJlcjtcclxuICAgIGJ5dGVzOiBCdWZmZXI7XHJcbiAgICBqc29uOiB7IG5hbWU6IHN0cmluZywgaWQ6IHN0cmluZyB9ICYgYW55XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBCZHRMcGNSZXNwID0ge1xyXG4gICAgZXJyOiBFcnJvckNvZGUsXHJcbiAgICByZXNwPzogQmR0THBjQ29tbWFuZFxyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgQmR0THBjT3B0aW9ucyA9IHtcclxuICAgIGxvZ2dlcjogTG9nZ2VyO1xyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIEJkdExwYyBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgICBwcml2YXRlIG1fc29ja2V0PzogbmV0LlNvY2tldDtcclxuICAgIHByaXZhdGUgbV9iUXVldWU6IGJvb2xlYW47XHJcbiAgICBwcml2YXRlIG1fc2VuZENhY2hlczogQnVmZmVyW107XHJcbiAgICBwcml2YXRlIG1fcmVjdkNhY2hlPzogQnVmZmVyO1xyXG4gICAgcHJpdmF0ZSBtX3ZlcnNpb246IG51bWJlciA9IDE7XHJcbiAgICBwcml2YXRlIG1fbG9nZ2VyOiBMb2dnZXI7XHJcbiAgICBwcml2YXRlIG1faWQ/OiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIG1fY21kX3NlcTogbnVtYmVyID0gMDtcclxuXHJcbiAgICBvbihldmVudDogJ2Vycm9yJywgbGlzdGVuZXI6IChscGM6IEJkdExwYywgZXJyOiBFcnJvckNvZGUpID0+IHZvaWQpOiB0aGlzO1xyXG4gICAgb24oZXZlbnQ6ICdjbG9zZScsIGxpc3RlbmVyOiAobHBjOiBCZHRMcGMsIGVycjogYm9vbGVhbikgPT4gdm9pZCk6IHRoaXM7XHJcbiAgICBvbihldmVudDogJ2NvbW1hbmQnLCBsaXN0ZW5lcjogKGxwYzogQmR0THBjLCBjOiBCZHRMcGNDb21tYW5kKSA9PiB2b2lkKTogdGhpcztcclxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB0aGlzIHtcclxuICAgICAgICBzdXBlci5vbihldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIG9uY2UoZXZlbnQ6ICdlcnJvcicsIGxpc3RlbmVyOiAobHBjOiBCZHRMcGMsIGVycjogRXJyb3JDb2RlKSA9PiB2b2lkKTogdGhpcztcclxuICAgIG9uY2UoZXZlbnQ6ICdjbG9zZScsIGxpc3RlbmVyOiAobHBjOiBCZHRMcGMsIGVycjogYm9vbGVhbikgPT4gdm9pZCk6IHRoaXM7XHJcbiAgICBvbmNlKGV2ZW50OiAnY29tbWFuZCcsIGxpc3RlbmVyOiAobHBjOiBCZHRMcGMsIGM6IEJkdExwY0NvbW1hbmQpID0+IHZvaWQpOiB0aGlzO1xyXG4gICAgb25jZShldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogdGhpcyB7XHJcbiAgICAgICAgc3VwZXIub25jZShldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IEJkdExwY09wdGlvbnMpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMubV9iUXVldWUgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLm1fbG9nZ2VyID0gb3B0aW9ucy5sb2dnZXI7XHJcbiAgICAgICAgdGhpcy5tX3NlbmRDYWNoZXMgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgaWQoczogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5tX2lkID0gcztcclxuICAgIH1cclxuXHJcbiAgICBpbml0RnJvbUxpc3RlbmVyKHNvY2tldDogbmV0LlNvY2tldCk6IEVycm9yQ29kZSB7XHJcbiAgICAgICAgdGhpcy5tX3NvY2tldCA9IHNvY2tldDtcclxuICAgICAgICB0aGlzLl9pbml0U29ja2V0KCk7XHJcbiAgICAgICAgcmV0dXJuIEVycm9yQ29kZS5zdWNjO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX25leHRfY21kX3NlcSgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1fY21kX3NlcSsrO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmQoY29tbWFuZDogQmR0THBjQ29tbWFuZCk6IEVycm9yQ29kZSB7XHJcbiAgICAgICAgY29tbWFuZC5zZXEgPSB0aGlzLl9uZXh0X2NtZF9zZXEoKTtcclxuICAgICAgICB0aGlzLm1fbG9nZ2VyLmRlYnVnKGBiZHRscGMgc2VuZCBjb21tYW5kIHRvIGJkdC5leGUsIHNlcT0ke2NvbW1hbmQuc2VxIX0sIG5hbWU9JHtjb21tYW5kLmpzb24ubmFtZX1gKTtcclxuICAgICAgICBsZXQgaW5mbyA9IHRoaXMuX2VuY29kZU1zZyhjb21tYW5kKTtcclxuICAgICAgICBpZiAoaW5mby5lcnIpIHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgYmR0bHBjIHNlbmQgY29tbWFuZCB0byBiZHQuZXhlIGZhaWxlZCxmb3IgZW5jb2RlIGZhaWxlZCwgZXJyPSR7aW5mby5lcnJ9fWApO1xyXG4gICAgICAgICAgICByZXR1cm4gaW5mby5lcnI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLl9zZW5kKGluZm8uYnVmZmVyISk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgd2FpdF9yZXNwKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBQcm9taXNlPHsgZXJyOiBFcnJvckNvZGUsIHJlc3A/OiBCZHRMcGNDb21tYW5kIH0+IHtcclxuICAgICAgICBsZXQgZXJyID0gdGhpcy5zZW5kKGNvbW1hbmQpO1xyXG4gICAgICAgIGlmIChlcnIgIT09IEVycm9yQ29kZS5zdWNjKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IGVyciB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8eyBlcnI6IEVycm9yQ29kZSwgcmVzcD86IEJkdExwY0NvbW1hbmQgfT4oKHYpID0+IHtcclxuICAgICAgICAgICAgbGV0IG9uRnVuYyA9IChscGM6IEJkdExwYywgcmVzcDogQmR0THBjQ29tbWFuZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3AuanNvbi5uYW1lICE9PSBcInBpbmdcIiAmJiByZXNwLnNlcSEgPT09IGNvbW1hbmQuc2VxISkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxwYy5yZW1vdmVMaXN0ZW5lcignY29tbWFuZCcsIG9uRnVuYyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdih7IGVycjogRXJyb3JDb2RlLnN1Y2MsIHJlc3AgfSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5vbignY29tbWFuZCcsIG9uRnVuYyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfc2VuZChidWZmOiBCdWZmZXIpOiBFcnJvckNvZGUge1xyXG4gICAgICAgIGlmICh0aGlzLm1fYlF1ZXVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9zZW5kQ2FjaGVzLnB1c2goYnVmZik7XHJcbiAgICAgICAgICAgIHJldHVybiBFcnJvckNvZGUuc3VjYztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9iUXVldWUgPSAhdGhpcy5tX3NvY2tldCEud3JpdGUoYnVmZik7XHJcbiAgICAgICAgICAgIHJldHVybiBFcnJvckNvZGUuc3VjYztcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9sb2dnZXIuZXJyb3IoYGJkdGxwYyBzZW5kIGZhaWxlZCwgZXJyb3I9JHtlfSwgcz0ke3RoaXMubV9pZH1gKTtcclxuICAgICAgICAgICAgcmV0dXJuIEVycm9yQ29kZS5mYWlsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9pbml0U29ja2V0KCkge1xyXG4gICAgICAgIHRoaXMubV9zb2NrZXQhLm9uKCdkcmFpbicsICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubV9zZW5kQ2FjaGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGJ1ZmYgPSBCdWZmZXIuY29uY2F0KHRoaXMubV9zZW5kQ2FjaGVzKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubV9zZW5kQ2FjaGVzID0gW107XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1fYlF1ZXVlID0gIXRoaXMubV9zb2NrZXQhLndyaXRlKGJ1ZmYpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tX2JRdWV1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMubV9zb2NrZXQhLm9uKCdkYXRhJywgKGRhdGE6IEJ1ZmZlcikgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tX3JlY3ZDYWNoZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tX3JlY3ZDYWNoZSA9IEJ1ZmZlci5jb25jYXQoW3RoaXMubV9yZWN2Q2FjaGUsIGRhdGFdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubV9yZWN2Q2FjaGUgPSBkYXRhO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLzIgPSBsZW5ndGgoMilcclxuICAgICAgICAgICAgd2hpbGUgKHRoaXMubV9yZWN2Q2FjaGUgJiYgdGhpcy5tX3JlY3ZDYWNoZS5sZW5ndGggPiAyKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbXNnSW5mbyA9IHRoaXMuX2RlY29kZU1zZygpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1zZ0luZm8uZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgYmR0bHBjIGRlY29kZSBmYWlsZWQsIGVycj0ke21zZ0luZm8uZXJyfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtc2dJbmZvLmVyciAhPT0gRXJyb3JDb2RlLm5vTW9yZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tX3JlY3ZDYWNoZSA9IEJ1ZmZlci5mcm9tKCcnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjb21tYW5kJywgdGhpcywgbXNnSW5mby5jb21tYW5kISk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tX3NvY2tldCEub24oJ2Vycm9yJywgKGVycikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgdGhpcywgRXJyb3JDb2RlLmZhaWwpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIHRoaXMubV9zb2NrZXQhLm9uKCdjbG9zZScsIChoYWRfZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgYmR0bHBjIHNvY2tldCBjbG9zZSAke2hhZF9lcnJvcn1gKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdjbG9zZScsIHRoaXMsIGhhZF9lcnJvcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZGVjb2RlTXNnKCk6IHsgZXJyOiBFcnJvckNvZGUsIGNvbW1hbmQ/OiBCZHRMcGNDb21tYW5kIH0ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCBkZWNvZGVPZmZzZXQ6IG51bWJlciA9IDA7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm1fcmVjdkNhY2hlIS5sZW5ndGggPCA0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBub3QgZ2V0IGxlbmd0aCB3aGVuIGRlY29kZSBmb3Igbm8gbW9yZSBkYXRhLCBsZW5ndGg9JHt0aGlzLm1fcmVjdkNhY2hlIS5sZW5ndGh9LCBuZWVkPSR7NCArIGRlY29kZU9mZnNldH1gKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLm5vTW9yZURhdGEgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgbGVuZ3RoID0gdGhpcy5tX3JlY3ZDYWNoZSEucmVhZFVJbnQzMkxFKGRlY29kZU9mZnNldCk7XHJcbiAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSA0O1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMubV9yZWN2Q2FjaGUhLmxlbmd0aCA8IDQgKyBsZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubV9sb2dnZXIuZXJyb3IoYG5vdCBnZXQgbGVuZ3RoIHdoZW4gZGVjb2RlIGZvciBubyBtb3JlIGRhdGEsIGxlbmd0aD0ke3RoaXMubV9yZWN2Q2FjaGUhLmxlbmd0aH0sIG5lZWQ9JHs0ICsgZGVjb2RlT2Zmc2V0fWApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBFcnJvckNvZGUubm9Nb3JlRGF0YSB9O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgc2VxID0gdGhpcy5tX3JlY3ZDYWNoZSEucmVhZFVJbnQzMkxFKGRlY29kZU9mZnNldCk7XHJcbiAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSA0O1xyXG5cclxuICAgICAgICAgICAgbGV0IGJ5dGVzTGVuZ3RoID0gdGhpcy5tX3JlY3ZDYWNoZSEucmVhZFVJbnQzMkxFKGRlY29kZU9mZnNldCk7XHJcbiAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSA0O1xyXG5cclxuICAgICAgICAgICAgbGV0IGJ5dGVzOiBCdWZmZXIgPSBCdWZmZXIuZnJvbSgnJyk7XHJcbiAgICAgICAgICAgIGlmIChieXRlc0xlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgYnl0ZXMgPSB0aGlzLm1fcmVjdkNhY2hlIS5zbGljZShkZWNvZGVPZmZzZXQsIGRlY29kZU9mZnNldCArIGJ5dGVzTGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSBieXRlc0xlbmd0aDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGpzb25MZW5ndGggPSBsZW5ndGggLSA4IC0gYnl0ZXNMZW5ndGg7XHJcbiAgICAgICAgICAgIGxldCBqc29uQnVmZmVyID0gdGhpcy5tX3JlY3ZDYWNoZSEuc2xpY2UoZGVjb2RlT2Zmc2V0LCBkZWNvZGVPZmZzZXQgKyBqc29uTGVuZ3RoKTtcclxuICAgICAgICAgICAgZGVjb2RlT2Zmc2V0ICs9IGpzb25MZW5ndGg7XHJcbiAgICAgICAgICAgIHRoaXMubV9yZWN2Q2FjaGUgPSB0aGlzLm1fcmVjdkNhY2hlIS5zbGljZShkZWNvZGVPZmZzZXQpO1xyXG4gICAgICAgICAgICAvL3RoaXMubV9sb2dnZXIuZGVidWcoYC0tLS0tLS0tLS0tLS0tLS0tJHtqc29uQnVmZmVyLnRvU3RyaW5nKCd1dGYtOCcpfSwgZGVjb2RlT2Zmc2V0PSR7ZGVjb2RlT2Zmc2V0fSwgbGVuZ3RoPSR7dGhpcy5tX3JlY3ZDYWNoZSEubGVuZ3RofWApO1xyXG5cclxuICAgICAgICAgICAgbGV0IGpzb24gPSBKU09OLnBhcnNlKGpzb25CdWZmZXIudG9TdHJpbmcoJ3V0Zi04JykpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQgPSB7IHNlcSwgYnl0ZXMsIGpzb24gfTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBFcnJvckNvZGUuc3VjYywgY29tbWFuZCB9O1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgYmR0bHBjIGRlY29kZSBtc2cgZXhjZXB0aW9uLCBlPSR7ZX1gKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBFcnJvckNvZGUuZXhjZXB0aW9uIH07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2VuY29kZU1zZyhjb21tYW5kOiBCZHRMcGNDb21tYW5kKTogeyBlcnI6IEVycm9yQ29kZSwgYnVmZmVyPzogQnVmZmVyIH0ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCBidWZmZXI6IEJ1ZmZlciA9IG5ldyBCdWZmZXIoNC8qdG90YWwqLyArIDQvKnNlcSovICsgNC8qYnl0ZXMgbGVuZ3RoKi8pO1xyXG5cclxuICAgICAgICAgICAgbGV0IGpzb25TdHIgPSBKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pO1xyXG4gICAgICAgICAgICBsZXQgdG90YWw6IG51bWJlciA9IDQgKyA0ICsgY29tbWFuZC5ieXRlcy5sZW5ndGggKyBqc29uU3RyLmxlbmd0aDtcclxuICAgICAgICAgICAgYnVmZmVyLndyaXRlVUludDMyTEUodG90YWwsIDApO1xyXG4gICAgICAgICAgICBidWZmZXIud3JpdGVVSW50MzJMRShjb21tYW5kLnNlcSEsIDQpO1xyXG4gICAgICAgICAgICBidWZmZXIud3JpdGVVSW50MzJMRShjb21tYW5kLmJ5dGVzLmxlbmd0aCwgOCk7XHJcblxyXG4gICAgICAgICAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtidWZmZXIsIGNvbW1hbmQuYnl0ZXMsIEJ1ZmZlci5mcm9tKGpzb25TdHIpXSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4geyBlcnI6IEVycm9yQ29kZS5zdWNjLCBidWZmZXIgfTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9sb2dnZXIuZXJyb3IoYGJkdGxwYyBlbmNvZGUgbXNnIGV4Y2VwdGlvbiwgZT0ke2V9YCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLmV4Y2VwdGlvbiB9O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==
