"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BdtLpc = void 0;
const base_1 = require("../../base");
const events_1 = require("events");
class BdtLpc extends events_1.EventEmitter {
    constructor(options) {
        super();
        this.m_version = 1;
        this.m_cmd_seq = 0;
        this.m_bQueue = false;
        this.m_logger = options.logger;
        this.m_sendCaches = [];
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    once(event, listener) {
        super.once(event, listener);
        return this;
    }
    set id(s) {
        this.m_id = s;
    }
    initFromListener(socket) {
        this.m_socket = socket;
        this._initSocket();
        return base_1.ErrorCode.succ;
    }
    _next_cmd_seq() {
        return this.m_cmd_seq++;
    }
    send(command) {
        command.seq = this._next_cmd_seq();
        this.m_logger.debug(`bdtlpc send command to bdt.exe, seq=${command.seq}, name=${command.json.name}`);
        let info = this._encodeMsg(command);
        if (info.err) {
            this.m_logger.error(`bdtlpc send command to bdt.exe failed,for encode failed, err=${info.err}}`);
            return info.err;
        }
        return this._send(info.buffer);
    }
    async wait_resp(command) {
        let err = this.send(command);
        if (err !== base_1.ErrorCode.succ) {
            return { err };
        }
        return await new Promise((v) => {
            let onFunc = (lpc, resp) => {
                if (resp.json.name !== "ping" && resp.seq === command.seq) {
                    lpc.removeListener('command', onFunc);
                    v({ err: base_1.ErrorCode.succ, resp });
                }
            };
            this.on('command', onFunc);
        });
    }
    _send(buff) {
        if (this.m_bQueue) {
            this.m_sendCaches.push(buff);
            return base_1.ErrorCode.succ;
        }
        try {
            this.m_bQueue = !this.m_socket.write(buff);
            return base_1.ErrorCode.succ;
        }
        catch (e) {
            this.m_logger.error(`bdtlpc send failed, error=${e}, s=${this.m_id}`);
            return base_1.ErrorCode.fail;
        }
    }
    _initSocket() {
        this.m_socket.on('drain', () => {
            if (this.m_sendCaches.length) {
                let buff = Buffer.concat(this.m_sendCaches);
                this.m_sendCaches = [];
                this.m_bQueue = !this.m_socket.write(buff);
            }
            else {
                this.m_bQueue = false;
            }
        });
        this.m_socket.on('data', (data) => {
            if (this.m_recvCache) {
                this.m_recvCache = Buffer.concat([this.m_recvCache, data]);
            }
            else {
                this.m_recvCache = data;
            }
            //2 = length(2)
            while (this.m_recvCache && this.m_recvCache.length > 2) {
                let msgInfo = this._decodeMsg();
                if (msgInfo.err) {
                    this.m_logger.error(`bdtlpc decode failed, err=${msgInfo.err}`);
                    if (msgInfo.err !== base_1.ErrorCode.noMoreData) {
                        this.m_recvCache = Buffer.from('');
                    }
                    break;
                }
                this.emit('command', this, msgInfo.command);
            }
        });
        this.m_socket.on('error', (err) => {
            this.emit('error', this, base_1.ErrorCode.fail);
        });
        this.m_socket.on('close', (had_error) => {
            this.m_logger.error(`bdtlpc socket close ${had_error}`);
            this.emit('close', this, had_error);
        });
    }
    _decodeMsg() {
        try {
            let decodeOffset = 0;
            if (this.m_recvCache.length < 4) {
                this.m_logger.error(`not get length when decode for no more data, length=${this.m_recvCache.length}, need=${4 + decodeOffset}`);
                return { err: base_1.ErrorCode.noMoreData };
            }
            let length = this.m_recvCache.readUInt32LE(decodeOffset);
            decodeOffset += 4;
            if (this.m_recvCache.length < 4 + length) {
                this.m_logger.error(`not get length when decode for no more data, length=${this.m_recvCache.length}, need=${4 + decodeOffset}`);
                return { err: base_1.ErrorCode.noMoreData };
            }
            let seq = this.m_recvCache.readUInt32LE(decodeOffset);
            decodeOffset += 4;
            let bytesLength = this.m_recvCache.readUInt32LE(decodeOffset);
            decodeOffset += 4;
            let bytes = Buffer.from('');
            if (bytesLength) {
                bytes = this.m_recvCache.slice(decodeOffset, decodeOffset + bytesLength);
                decodeOffset += bytesLength;
            }
            let jsonLength = length - 8 - bytesLength;
            let jsonBuffer = this.m_recvCache.slice(decodeOffset, decodeOffset + jsonLength);
            decodeOffset += jsonLength;
            this.m_recvCache = this.m_recvCache.slice(decodeOffset);
            //this.m_logger.debug(`-----------------${jsonBuffer.toString('utf-8')}, decodeOffset=${decodeOffset}, length=${this.m_recvCache!.length}`);
            let json = JSON.parse(jsonBuffer.toString('utf-8'));
            let command = { seq, bytes, json };
            return { err: base_1.ErrorCode.succ, command };
        }
        catch (e) {
            this.m_logger.error(`bdtlpc decode msg exception, e=${e}`);
            return { err: base_1.ErrorCode.exception };
        }
    }
    _encodeMsg(command) {
        try {
            let buffer = new Buffer(4 /*total*/ + 4 /*seq*/ + 4 /*bytes length*/);
            let jsonStr = JSON.stringify(command.json);
            let total = 4 + 4 + command.bytes.length + jsonStr.length;
            buffer.writeUInt32LE(total, 0);
            buffer.writeUInt32LE(command.seq, 4);
            buffer.writeUInt32LE(command.bytes.length, 8);
            buffer = Buffer.concat([buffer, command.bytes, Buffer.from(jsonStr)]);
            return { err: base_1.ErrorCode.succ, buffer };
        }
        catch (e) {
            this.m_logger.error(`bdtlpc encode msg exception, e=${e}`);
            return { err: base_1.ErrorCode.exception };
        }
    }
}
exports.BdtLpc = BdtLpc;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlLXRlc3Rlci1hcHAvc2VydmljZS9jeWZzX2JkdC9scGMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQTZDO0FBRTdDLG1DQUFvQztBQWlCcEMsTUFBYSxNQUFPLFNBQVEscUJBQVk7SUEwQnBDLFlBQVksT0FBc0I7UUFDOUIsS0FBSyxFQUFFLENBQUM7UUF0QkosY0FBUyxHQUFXLENBQUMsQ0FBQztRQUd0QixjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBb0IxQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDL0IsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQWxCRCxFQUFFLENBQUMsS0FBYSxFQUFFLFFBQWtDO1FBQ2hELEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFLRCxJQUFJLENBQUMsS0FBYSxFQUFFLFFBQWtDO1FBQ2xELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFTRCxJQUFJLEVBQUUsQ0FBQyxDQUFTO1FBQ1osSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVELGdCQUFnQixDQUFDLE1BQWtCO1FBQy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixPQUFPLGdCQUFTLENBQUMsSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFFTyxhQUFhO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLENBQUMsT0FBc0I7UUFDdkIsT0FBTyxD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LENBQUMsQ0FBQSxPQUFPLEdBQUcsQ0FBQyxDQUFBLGdCQUFnQixDQUFDLENBQUM7WUFFM0UsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsSUFBSSxLQUFLLEdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBRTlDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxnQkFBUyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQztTQUMxQztRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDM0QsT0FBTyxFQUFDLEdBQUcsRUFBRSxnQkFBUyxDQUFDLFNBQVMsRUFBQyxDQUFDO1NBQ3JDO0lBQ0wsQ0FBQztDQUNKO0FBbE1ELHdCQWtNQyIsImZpbGUiOiJzZXJ2aWNlL2N5ZnNfYmR0L2xwYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXJyb3JDb2RlLCBMb2dnZXJ9IGZyb20gJy4uLy4uL2Jhc2UnO1xyXG5pbXBvcnQgKiBhcyBuZXQgZnJvbSAnbmV0JztcclxuaW1wb3J0IHtFdmVudEVtaXR0ZXJ9IGZyb20gJ2V2ZW50cyc7XHJcblxyXG5leHBvcnQgdHlwZSBCZHRMcGNDb21tYW5kID0ge1xyXG4gICAgc2VxPzogbnVtYmVyO1xyXG4gICAgYnl0ZXM6IEJ1ZmZlcjtcclxuICAgIGpzb246IHtuYW1lOiBzdHJpbmcsIGlkOiBzdHJpbmd9ICYgYW55XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBCZHRMcGNSZXNwID0ge1xyXG4gICAgZXJyOkVycm9yQ29kZSxcclxuICAgIHJlc3A/OkJkdExwY0NvbW1hbmRcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIEJkdExwY09wdGlvbnMgPSB7XHJcbiAgICBsb2dnZXI6IExvZ2dlcjtcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBCZHRMcGMgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xyXG4gICAgcHJpdmF0ZSBtX3NvY2tldD86IG5ldC5Tb2NrZXQ7XHJcbiAgICBwcml2YXRlIG1fYlF1ZXVlOiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBtX3NlbmRDYWNoZXM6IEJ1ZmZlcltdO1xyXG4gICAgcHJpdmF0ZSBtX3JlY3ZDYWNoZT86IEJ1ZmZlcjtcclxuICAgIHByaXZhdGUgbV92ZXJzaW9uOiBudW1iZXIgPSAxO1xyXG4gICAgcHJpdmF0ZSBtX2xvZ2dlcjogTG9nZ2VyO1xyXG4gICAgcHJpdmF0ZSBtX2lkPzogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBtX2NtZF9zZXE6IG51bWJlciA9IDA7XHJcblxyXG4gICAgb24oZXZlbnQ6ICdlcnJvcicsIGxpc3RlbmVyOiAobHBjOiBCZHRMcGMsIGVycjogRXJyb3JDb2RlKSA9PiB2b2lkKTogdGhpcztcclxuICAgIG9uKGV2ZW50OiAnY2xvc2UnLCBsaXN0ZW5lcjogKGxwYzogQmR0THBjLCBlcnI6IGJvb2xlYW4pID0+IHZvaWQpOiB0aGlzO1xyXG4gICAgb24oZXZlbnQ6ICdjb21tYW5kJywgbGlzdGVuZXI6IChscGM6IEJkdExwYywgYzogQmR0THBjQ29tbWFuZCkgPT4gdm9pZCk6IHRoaXM7XHJcbiAgICBvbihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogdGhpcyB7XHJcbiAgICAgICAgc3VwZXIub24oZXZlbnQsIGxpc3RlbmVyKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBvbmNlKGV2ZW50OiAnZXJyb3InLCBsaXN0ZW5lcjogKGxwYzogQmR0THBjLCBlcnI6IEVycm9yQ29kZSkgPT4gdm9pZCk6IHRoaXM7XHJcbiAgICBvbmNlKGV2ZW50OiAnY2xvc2UnLCBsaXN0ZW5lcjogKGxwYzogQmR0THBjLCBlcnI6IGJvb2xlYW4pID0+IHZvaWQpOiB0aGlzO1xyXG4gICAgb25jZShldmVudDogJ2NvbW1hbmQnLCBsaXN0ZW5lcjogKGxwYzogQmR0THBjLCBjOiBCZHRMcGNDb21tYW5kKSA9PiB2b2lkKTogdGhpcztcclxuICAgIG9uY2UoZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IHRoaXMge1xyXG4gICAgICAgIHN1cGVyLm9uY2UoZXZlbnQsIGxpc3RlbmVyKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBCZHRMcGNPcHRpb25zKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLm1fYlF1ZXVlID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5tX2xvZ2dlciA9IG9wdGlvbnMubG9nZ2VyO1xyXG4gICAgICAgIHRoaXMubV9zZW5kQ2FjaGVzID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGlkKHM6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMubV9pZCA9IHM7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEZyb21MaXN0ZW5lcihzb2NrZXQ6IG5ldC5Tb2NrZXQpOiBFcnJvckNvZGUge1xyXG4gICAgICAgIHRoaXMubV9zb2NrZXQgPSBzb2NrZXQ7XHJcbiAgICAgICAgdGhpcy5faW5pdFNvY2tldCgpO1xyXG4gICAgICAgIHJldHVybiBFcnJvckNvZGUuc3VjYztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9uZXh0X2NtZF9zZXEoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tX2NtZF9zZXErKztcclxuICAgIH1cclxuXHJcbiAgICBzZW5kKGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQpOiBFcnJvckNvZGUge1xyXG4gICAgICAgIGNvbW1hbmQuc2VxID0gdGhpcy5fbmV4dF9jbWRfc2VxKCk7XHJcbiAgICAgICAgdGhpcy5tX2xvZ2dlci5kZWJ1ZyhgYmR0bHBjIHNlbmQgY29tbWFuZCB0byBiZHQuZXhlLCBzZXE9JHtjb21tYW5kLnNlcSF9LCBuYW1lPSR7Y29tbWFuZC5qc29uLm5hbWV9YCk7XHJcbiAgICAgICAgbGV0IGluZm8gPSB0aGlzLl9lbmNvZGVNc2coY29tbWFuZCk7XHJcbiAgICAgICAgaWYgKGluZm8uZXJyKSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9sb2dnZXIuZXJyb3IoYGJkdGxwYyBzZW5kIGNvbW1hbmQgdG8gYmR0LmV4ZSBmYWlsZWQsZm9yIGVuY29kZSBmYWlsZWQsIGVycj0ke2luZm8uZXJyfX1gKTtcclxuICAgICAgICAgICAgcmV0dXJuIGluZm8uZXJyO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VuZChpbmZvLmJ1ZmZlciEpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHdhaXRfcmVzcChjb21tYW5kOiBCZHRMcGNDb21tYW5kKTogUHJvbWlzZTx7ZXJyOiBFcnJvckNvZGUsIHJlc3A/OiBCZHRMcGNDb21tYW5kfT4ge1xyXG4gICAgICAgIGxldCBlcnIgPSB0aGlzLnNlbmQoY29tbWFuZCk7XHJcbiAgICAgICAgaWYgKGVyciAhPT0gRXJyb3JDb2RlLnN1Y2MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHtlcnJ9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8e2VycjogRXJyb3JDb2RlLCByZXNwPzogQmR0THBjQ29tbWFuZH0+KCh2KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBvbkZ1bmMgPSAobHBjOiBCZHRMcGMsIHJlc3A6IEJkdExwY0NvbW1hbmQpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXNwLmpzb24ubmFtZSAhPT0gXCJwaW5nXCIgJiYgcmVzcC5zZXEhID09PSBjb21tYW5kLnNlcSEpIHtcclxuICAgICAgICAgICAgICAgICAgICBscGMucmVtb3ZlTGlzdGVuZXIoJ2NvbW1hbmQnLCBvbkZ1bmMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHYoe2VycjogRXJyb3JDb2RlLnN1Y2MsIHJlc3B9KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLm9uKCdjb21tYW5kJywgb25GdW5jKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9zZW5kKGJ1ZmY6IEJ1ZmZlcik6IEVycm9yQ29kZSB7XHJcbiAgICAgICAgaWYgKHRoaXMubV9iUXVldWUpIHtcclxuICAgICAgICAgICAgdGhpcy5tX3NlbmRDYWNoZXMucHVzaChidWZmKTtcclxuICAgICAgICAgICAgcmV0dXJuIEVycm9yQ29kZS5zdWNjO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5tX2JRdWV1ZSA9ICF0aGlzLm1fc29ja2V0IS53cml0ZShidWZmKTtcclxuICAgICAgICAgICAgcmV0dXJuIEVycm9yQ29kZS5zdWNjO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgYmR0bHBjIHNlbmQgZmFpbGVkLCBlcnJvcj0ke2V9LCBzPSR7dGhpcy5tX2lkfWApO1xyXG4gICAgICAgICAgICByZXR1cm4gRXJyb3JDb2RlLmZhaWw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2luaXRTb2NrZXQoKSB7XHJcbiAgICAgICAgdGhpcy5tX3NvY2tldCEub24oJ2RyYWluJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tX3NlbmRDYWNoZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYnVmZiA9IEJ1ZmZlci5jb25jYXQodGhpcy5tX3NlbmRDYWNoZXMpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tX3NlbmRDYWNoZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgIHRoaXMubV9iUXVldWUgPSAhdGhpcy5tX3NvY2tldCEud3JpdGUoYnVmZik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1fYlF1ZXVlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tX3NvY2tldCEub24oJ2RhdGEnLCAoZGF0YTogQnVmZmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm1fcmVjdkNhY2hlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1fcmVjdkNhY2hlID0gQnVmZmVyLmNvbmNhdChbdGhpcy5tX3JlY3ZDYWNoZSwgZGF0YV0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tX3JlY3ZDYWNoZSA9IGRhdGE7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vMiA9IGxlbmd0aCgyKVxyXG4gICAgICAgICAgICB3aGlsZSAodGhpcy5tX3JlY3ZDYWNoZSAmJiB0aGlzLm1fcmVjdkNhY2hlLmxlbmd0aCA+IDIpIHtcclxuICAgICAgICAgICAgICAgIGxldCBtc2dJbmZvID0gdGhpcy5fZGVjb2RlTXNnKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAobXNnSW5mby5lcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBiZHRscGMgZGVjb2RlIGZhaWxlZCwgZXJyPSR7bXNnSW5mby5lcnJ9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1zZ0luZm8uZXJyICE9PSBFcnJvckNvZGUubm9Nb3JlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1fcmVjdkNhY2hlID0gQnVmZmVyLmZyb20oJycpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjb21tYW5kJywgdGhpcywgbXNnSW5mby5jb21tYW5kISk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tX3NvY2tldCEub24oJ2Vycm9yJywgKGVycikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgdGhpcywgRXJyb3JDb2RlLmZhaWwpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIHRoaXMubV9zb2NrZXQhLm9uKCdjbG9zZScsIChoYWRfZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgYmR0bHBjIHNvY2tldCBjbG9zZSAke2hhZF9lcnJvcn1gKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdjbG9zZScsIHRoaXMsIGhhZF9lcnJvcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZGVjb2RlTXNnKCk6IHtlcnI6IEVycm9yQ29kZSwgY29tbWFuZD86IEJkdExwY0NvbW1hbmR9IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsZXQgZGVjb2RlT2Zmc2V0OiBudW1iZXIgPSAwO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tX3JlY3ZDYWNoZSEubGVuZ3RoIDwgNCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgbm90IGdldCBsZW5ndGggd2hlbiBkZWNvZGUgZm9yIG5vIG1vcmUgZGF0YSwgbGVuZ3RoPSR7dGhpcy5tX3JlY3ZDYWNoZSEubGVuZ3RofSwgbmVlZD0kezQrZGVjb2RlT2Zmc2V0fWApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBFcnJvckNvZGUubm9Nb3JlRGF0YSB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBsZW5ndGggPSB0aGlzLm1fcmVjdkNhY2hlIS5yZWFkVUludDMyTEUoZGVjb2RlT2Zmc2V0KTtcclxuICAgICAgICAgICAgZGVjb2RlT2Zmc2V0ICs9IDQ7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5tX3JlY3ZDYWNoZSEubGVuZ3RoIDwgNCArIGxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tX2xvZ2dlci5lcnJvcihgbm90IGdldCBsZW5ndGggd2hlbiBkZWNvZGUgZm9yIG5vIG1vcmUgZGF0YSwgbGVuZ3RoPSR7dGhpcy5tX3JlY3ZDYWNoZSEubGVuZ3RofSwgbmVlZD0kezQrZGVjb2RlT2Zmc2V0fWApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBFcnJvckNvZGUubm9Nb3JlRGF0YSB9O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgc2VxID0gdGhpcy5tX3JlY3ZDYWNoZSEucmVhZFVJbnQzMkxFKGRlY29kZU9mZnNldCk7XHJcbiAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSA0O1xyXG5cclxuICAgICAgICAgICAgbGV0IGJ5dGVzTGVuZ3RoID0gdGhpcy5tX3JlY3ZDYWNoZSEucmVhZFVJbnQzMkxFKGRlY29kZU9mZnNldCk7XHJcbiAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSA0O1xyXG5cclxuICAgICAgICAgICAgbGV0IGJ5dGVzOiBCdWZmZXIgPSBCdWZmZXIuZnJvbSgnJyk7XHJcbiAgICAgICAgICAgIGlmIChieXRlc0xlbmd0aClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgYnl0ZXMgPSB0aGlzLm1fcmVjdkNhY2hlIS5zbGljZShkZWNvZGVPZmZzZXQsIGRlY29kZU9mZnNldCArIGJ5dGVzTGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIGRlY29kZU9mZnNldCArPSBieXRlc0xlbmd0aDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGpzb25MZW5ndGggPSBsZW5ndGggLSA4IC0gYnl0ZXNMZW5ndGg7XHJcbiAgICAgICAgICAgIGxldCBqc29uQnVmZmVyID0gdGhpcy5tX3JlY3ZDYWNoZSEuc2xpY2UoZGVjb2RlT2Zmc2V0LCBkZWNvZGVPZmZzZXQgKyBqc29uTGVuZ3RoKTtcclxuICAgICAgICAgICAgZGVjb2RlT2Zmc2V0ICs9IGpzb25MZW5ndGg7XHJcbiAgICAgICAgICAgIHRoaXMubV9yZWN2Q2FjaGUgPSB0aGlzLm1fcmVjdkNhY2hlIS5zbGljZShkZWNvZGVPZmZzZXQpO1xyXG4gICAgICAgICAgICAvL3RoaXMubV9sb2dnZXIuZGVidWcoYC0tLS0tLS0tLS0tLS0tLS0tJHtqc29uQnVmZmVyLnRvU3RyaW5nKCd1dGYtOCcpfSwgZGVjb2RlT2Zmc2V0PSR7ZGVjb2RlT2Zmc2V0fSwgbGVuZ3RoPSR7dGhpcy5tX3JlY3ZDYWNoZSEubGVuZ3RofWApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IGpzb24gPSBKU09OLnBhcnNlKGpzb25CdWZmZXIudG9TdHJpbmcoJ3V0Zi04JykpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGNvbW1hbmQ6IEJkdExwY0NvbW1hbmQgPSB7c2VxLCBieXRlcywganNvbn07XHJcbiAgICAgICAgICAgIHJldHVybiB7IGVycjogRXJyb3JDb2RlLnN1Y2MsICBjb21tYW5kfTsgXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1fbG9nZ2VyLmVycm9yKGBiZHRscGMgZGVjb2RlIG1zZyBleGNlcHRpb24sIGU9JHtlfWApO1xyXG4gICAgICAgICAgICByZXR1cm4ge2VycjogRXJyb3JDb2RlLmV4Y2VwdGlvbn07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2VuY29kZU1zZyhjb21tYW5kOiBCZHRMcGNDb21tYW5kKTogeyBlcnI6IEVycm9yQ29kZSwgYnVmZmVyPzogQnVmZmVyIH0ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCBidWZmZXI6IEJ1ZmZlciA9IG5ldyBCdWZmZXIoNC8qdG90YWwqLyArIDQvKnNlcSovICsgNC8qYnl0ZXMgbGVuZ3RoKi8pO1xyXG5cclxuICAgICAgICAgICAgbGV0IGpzb25TdHIgPSBKU09OLnN0cmluZ2lmeShjb21tYW5kLmpzb24pO1xyXG4gICAgICAgICAgICBsZXQgdG90YWw6IG51bWJlciA9IDQgKyA0ICsgY29tbWFuZC5ieXRlcy5sZW5ndGggKyBqc29uU3RyLmxlbmd0aDtcclxuICAgICAgICAgICAgYnVmZmVyLndyaXRlVUludDMyTEUodG90YWwsIDApO1xyXG4gICAgICAgICAgICBidWZmZXIud3JpdGVVSW50MzJMRShjb21tYW5kLnNlcSEsIDQpO1xyXG4gICAgICAgICAgICBidWZmZXIud3JpdGVVSW50MzJMRShjb21tYW5kLmJ5dGVzLmxlbmd0aCwgOCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtidWZmZXIsIGNvbW1hbmQuYnl0ZXMsIEJ1ZmZlci5mcm9tKGpzb25TdHIpXSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4geyBlcnI6IEVycm9yQ29kZS5zdWNjLCBidWZmZXIgfTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubV9sb2dnZXIuZXJyb3IoYGJkdGxwYyBlbmNvZGUgbXNnIGV4Y2VwdGlvbiwgZT0ke2V9YCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7ZXJyOiBFcnJvckNvZGUuZXhjZXB0aW9ufTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=
