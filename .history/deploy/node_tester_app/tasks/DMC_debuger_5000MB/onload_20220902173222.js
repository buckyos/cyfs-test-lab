"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TaskMain = void 0;
const base_1 = require("../../base");
const path = __importStar(require("path"));
const stackTool_1 = require("./stackTool");
const cyfs = __importStar(require("./cyfs_node"));
async function test_file(_interface, DMC_Download, DMC_Upload, stack_download, stack_upload, fileSize, timeout) {
    let dec_id = cyfs.ObjectId.from_base_58("9tGpLNnab9uVtjeaK4bM59QKSkLEGWow1pJq6hjjK9MM").unwrap();
    let download_path = await DMC_Download.util_client.getCachePath();
    let createFile = await DMC_Upload.util_client.createFile(fileSize);
    let add_file = await stack_upload.trans().publish_file({
        common: {
            req_path: "qaTest",
            // 来源DEC
            // api级别
            dec_id,
            level: cyfs.NDNAPILevel.NDN,
            target: stack_upload.local_device_id().object_id,
            // targrt设备参数
            // 需要处理数据的关联对象，主要用以chunk/file等
            referer_object: [],
            flags: 1,
        },
        owner: stack_upload.local_device_id().object_id,
        local_path: createFile.filePath,
        chunk_size: 4 * 1024 * 1024
    });
    let test_file = add_file.unwrap().file_id;
    let task_id;
    await cyfs.sleep(1000);
    const req1 = {
        object_id: test_file,
        common: {
            req_path: "qaTest",
            level: cyfs.NONAPILevel.NON,
            target: stack_upload.local_device_id().object_id,
            dec_id,
            flags: 0,
        }
    };
    const get_ret = await stack_upload.non_service().get_object(req1);
    let file_obj = get_ret.unwrap().object;
    let stream = await stack_upload.non_service().put_object({
        common: {
            dec_id,
            flags: 0,
            target: stack_download.local_device_id().object_id,
            level: cyfs.NONAPILevel.Router //设置路由类型
        },
        object: new cyfs.NONObjectInfo(test_file, file_obj.object_raw)
    });
    _interface.getLogger().info(`##### ${JSON.stringify(stream.unwrap().result)}`);
    await cyfs.sleep(1000);
    _interface.getLogger().info("获取task object");
    const req2 = {
        object_id: test_file,
        common: {
            req_path: "qaTest",
            level: cyfs.NONAPILevel.Router,
            target: stack_upload.local_device_id().object_id,
            dec_id,
            flags: 0,
        }
    };
    const get_ret2 = await stack_download.non_service().get_object(req2);
    get_ret2.unwrap().object;
    let save_filePath = path.join(download_path.cache_path.file_download, createFile.fileName);
    _interface.getLogger().info(`${JSON.stringify(get_ret2)}`);
    let begin = Date.now();
    let download = await stack_download.trans().create_task({
        common: {
            req_path: "qaTest",
            dec_id,
            level: cyfs.NDNAPILevel.Router,
            target: stack_download.local_device_id().object_id,
            referer_object: [new cyfs.NDNDataRefererObject(test_file)],
            flags: 1,
        },
        object_id: test_file,
        local_path: save_filePath,
        device_list: [stack_upload.local_device_id()],
        auto_start: true,
    });
    _interface.getLogger().info(`##${download}`);
    let download_id = download.unwrap().task_id;
    for (let i = 0; i < timeout; i++) {
        let task = await stack_download.trans().get_task_state({
            common: {
                req_path: "qaTest",
                dec_id,
                level: cyfs.NDNAPILevel.Router,
                referer_object: [],
                flags: 1,
            },
            task_id: download_id
        });
        _interface.getLogger().info(`####### 传输状态： ${JSON.stringify(task.unwrap())}`);
        let state = task.unwrap().state;
        if (state == 4) {
            _interface.getLogger().info(`####### 传输完成： ${JSON.stringify(task.unwrap())} ,time = ${Date.now() - begin} ,文件大小 : ${fileSize}`);
            return { err: base_1.ErrorCode.succ, fileId: test_file.to_base_58(), time: Date.now() - begin, fileSize };
        }
        if (state == 5) {
            _interface.getLogger().info(`####### 传输完成： ${JSON.stringify(task.unwrap())} ,time = ${Date.now() - begin} ,文件大小 : ${fileSize}`);
            return { err: base_1.ErrorCode.exception, fileId: test_file.to_base_58(), time: Date.now() - begin, fileSize };
        }
        await cyfs.sleep(1000);
    }
    return { err: base_1.ErrorCode.timeout, fileId: test_file.to_base_58(), time: Date.now() - begin, fileSize };
}
async function TaskMain(_interface) {
    let dec_id = cyfs.ObjectId.from_base_58("9tGpLNnab9uVtjeaK4bM59QKSkLEGWow1pJq6hjjK9MM").unwrap();
    let DMC_Download = new stackTool_1.StackProxyClient({
        _interface,
        peerName: "DMC_Download",
        stack_type: "ood",
        timeout: 60 * 1000,
        ws_port: 20001,
        http_port: 20002
    });
    await DMC_Download.init();
    let DMC_Upload = new stackTool_1.StackProxyClient({
        _interface,
        peerName: "DMC_Upload",
        stack_type: "ood",
        timeout: 60 * 1000,
        ws_port: 20003,
        http_port: 20004
    });
    await DMC_Upload.init();
    _interface.getLogger().info(`Waiting for proxy to connection...`);
    let stack_download = cyfs.SharedCyfsStack.open(cyfs.SharedCyfsStackParam.new_with_ws_event_ports(20002, 20001, dec_id).unwrap());
    let resp = await stack_download.wait_online(cyfs.None);
    _interface.getLogger().info(`wait_online finished ${JSON.stringify(resp.unwrap())}`);
    let res = await stack_download.util().get_zone({ common: { flags: 0 } });
    let stack_upload = cyfs.SharedCyfsStack.open(cyfs.SharedCyfsStackParam.new_with_ws_event_ports(20004, 20003, dec_id).unwrap());
    let resp2 = await stack_upload.wait_online(cyfs.None);
    _interface.getLogger().info(`wait_online finished ${JSON.stringify(resp.unwrap())}`);
    let res2 = await stack_upload.util().get_zone({ common: { flags: 0 } });
    let result = await test_file(_interface, DMC_Download, DMC_Upload, stack_download, stack_upload, 5000 * 1024 * 1024, 30000);
    await DMC_Download.util_client.getStackLog("/cyfs/log/gateway", "DMC_Download");
    await DMC_Upload.util_client.getStackLog("/cyfs/log/gateway", "DMC_Download");
    await _interface.exit(base_1.ClientExitCode.failed, `${result}`);
}
exports.TaskMain = TaskMain;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlLXRlc3Rlci1hcHAvdGFza3MvRE1DX2RlYnVnZXJfNTBNQi9vbmxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHFDQUFxSztBQUNySywyQ0FBNEI7QUFDNUIsMkVBQThFO0FBQzlFLGtGQUFtRTtBQUluRSxLQUFLLFVBQVUsU0FBUyxDQUFDLFVBQStCLEVBQUMsWUFBNkIsRUFBQyxVQUEyQixFQUFDLGNBQW1DLEVBQUMsWUFBaUMsRUFBQyxRQUFlLEVBQUMsT0FBYztJQUNuTixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2pHLElBQUksYUFBYSxHQUFHLE1BQU0sWUFBWSxDQUFDLFdBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNuRSxJQUFJLFVBQVUsR0FBRyxNQUFNLFVBQVUsQ0FBQyxXQUFZLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BFLElBQUksUUFBUSxHQUFHLE1BQU0sWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDLFlBQVksQ0FBQztRQUNuRCxNQUFNLEVBQUU7WUFDSixRQUFRLEVBQUUsUUFBUTtZQUNsQixRQUFRO1lBQ1IsUUFBUTtZQUNSLE1BQU07WUFDTixLQUFLLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHO1lBQzNCLE1BQU0sRUFBRyxZQUFZLENBQUMsZUFBZSxFQUFFLENBQUMsU0FBUztZQUNqRCxhQUFhO1lBQ2IsOEJBQThCO1lBQzlCLGNBQWMsRUFBRSxFQUFFO1lBQ2xCLEtBQUssRUFBRSxDQUFDO1NBQ1g7UUFDRCxLQUFLLEVBQUUsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDLFNBQVM7UUFDL0MsVUFBVSxFQUFFLFVBQVUsQ0FBQyxRQUFTO1FBQ2hDLFVBQVUsRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUk7S0FDOUIs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QUFDLG9CQUFvQixDQUFDLHVCQUF1QixDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTtJQUM3SCxJQUFJLEtBQUssR0FBRyxNQUFNLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RELFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3JGLElBQUksSUFBSSxHQUFHLE1BQU0sWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDeEUsSUFBSSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsVUFBVSxFQUFDLFlBQVksRUFBQyxVQUFVLEVBQUMsY0FBYyxFQUFDLFlBQVksRUFBQyxFQUFFLEdBQUMsSUFBSSxHQUFDLElBQUksRUFBQyxJQUFJLENBQUMsQ0FBQztJQUMvRyxNQUFNLFlBQVksQ0FBQyxXQUFZLENBQUMsV0FBVyxDQUFDLG1CQUFtQixFQUFDLGNBQWMsQ0FBQyxDQUFBO0lBQy9FLE1BQU0sVUFBVSxDQUFDLFdBQVksQ0FBQyxXQUFXLENBQUMsbUJBQW1CLEVBQUMsY0FBYyxDQUFDLENBQUE7SUFDN0UsTUFBTSxVQUFVLENBQUMsSUFBSSxDQUFDLHFCQUFjLENBQUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUMsQ0FBQTtBQUM3RCxDQUFDO0FBbkNELDRCQW1DQyIsImZpbGUiOiJ0YXNrcy9ETUNfZGVidWdlcl81ME1CL29ubG9hZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVycm9yQ29kZSwgTmV0RW50cnksIE5hbWVzcGFjZSwgQWNjZXNzTmV0VHlwZSwgQnVmZmVyUmVhZGVyLCBMb2dnZXIsIFRhc2tDbGllbnRJbnRlcmZhY2UsIENsaWVudEV4aXRDb2RlLCBCdWZmZXJXcml0ZXIsIFJhbmRvbUdlbmVyYXRvciB9IGZyb20gJy4uLy4uL2Jhc2UnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCJcclxuaW1wb3J0IHsgU3RhY2tQcm94eUNsaWVudCB9IGZyb20gXCIuLi8uLi90YXNrVG9vbHMvY3lmc19zdGFja190dW5uZWwvc3RhY2tUb29sXCJcclxuaW1wb3J0ICogYXMgY3lmcyBmcm9tIFwiLi4vLi4vdGFza1Rvb2xzL2N5ZnNfc3RhY2tfdHVubmVsL2N5ZnNfbm9kZVwiXHJcblxyXG5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHRlc3RfZmlsZShfaW50ZXJmYWNlOiBUYXNrQ2xpZW50SW50ZXJmYWNlLERNQ19Eb3dubG9hZDpTdGFja1Byb3h5Q2xpZW50LERNQ19VcGxvYWQ6U3RhY2tQcm94eUNsaWVudCxzdGFja19kb3dubG9hZDpjeWZzLlNoYXJlZEN5ZnNTdGFjayxzdGFja191cGxvYWQ6Y3lmcy5TaGFyZWRDeWZzU3RhY2ssZmlsZVNpemU6bnVtYmVyLHRpbWVvdXQ6bnVtYmVyKSB7XHJcbiAgICBsZXQgZGVjX2lkID0gY3lmcy5PYmplY3RJZC5mcm9tX2Jhc2VfNTgoXCI5dEdwTE5uYWI5dVZ0amVhSzRiTTU5UUtTa0xFR1dvdzFwSnE2aGpqSzlNTVwiKS51bndyYXAoKTtcclxuICAgIGxldCBkb3dubG9hZF9wYXRoID0gYXdhaXQgRE1DX0Rvd25sb2FkLnV0aWxfY2xpZW50IS5nZXRDYWNoZVBhdGgoKTtcclxuICAgIGxldCBjcmVhdGVGaWxlID0gYXdhaXQgRE1DX1VwbG9hZC51dGlsX2NsaWVudCEuY3JlYXRlRmlsZShmaWxlU2l6ZSk7XHJcbiAgICBsZXQgYWRkX2ZpbGUgPSBhd2FpdCBzdGFja191cGxvYWQudHJhbnMoKS5wdWJsaXNoX2ZpbGUoe1xyXG4gICAgICAgIGNvbW1vbjogey8vIOivt+axgui3r+W+hO+8jOWPr+S4uuepulxyXG4gICAgICAgICAgICByZXFfcGF0aDogXCJxYVRlc3RcIixcclxuICAgICAgICAgICAgLy8g5p2l5rqQREVDXHJcbiAgICAgICAgICAgIC8vIGFwaee6p+WIq1xyXG4gICAgICAgICAgICBkZWNfaWQsXHJcbiAgICAgICAgICAgIGxldmVsOiBjeWZzLk5ETkFQSUxldmVsLk5ETixcclxuICAgICAgICAgICAgdGFyZ2V0IDogc3RhY2tfdXBsb2FkLmxvY2FsX2RldmljZV9pZCgpLm9iamVjdF9pZCxcclxuICAgICAgICAgICAgLy8gdGFyZ3J06K6+5aSH5Y+C5pWwXHJcbiAgICAgICAgICAgIC8vIOmcgOimgeWkhOeQhuaVsOaNrueahOWFs+iBlOWvueixoe+8jOS4u+imgeeUqOS7pWNodW5rL2ZpbGXnrYlcclxuICAgICAgICAgICAgcmVmZXJlcl9vYmplY3Q6IFtdLFxyXG4gICAgICAgICAgICBmbGFnczogMSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIG93bmVyOiBzdGFja191cGxvYWQubG9jYWxfZGV2aWNlX2lkKCkub2JqZWN0X2lkLFxyXG4gICAgICAgIGxvY2FsX3BhdGg6IGNyZWF0ZUZpbGUuZmlsZVBhdGghLFxyXG4gICAgICAgIGNodW5rX3NpemU6IDQgKiAxMDI0ICogMTAyNFxyXG4gICAgfSk7XHJcbiAgIFxyXG4gICAgbGV0IHRlc3RfZmlsZSA9IGFkZF9maWxlLnVud3JhcCgpLmZpbGVfaWRcclxuICAgIGxldCB0YXNrX2lkOiBzdHJpbmc7XHJcbiAgICBhd2FpdCBjeWZzLnNsZWVwKDEwMDApXHJcblxyXG4gICAgY29uc3QgcmVxMTogY3lmcy5OT05HZXRPYmplY3RPdXRwdXRSZXF1ZXN0ID0ge1xyXG4gICAgICAgIG9iamVjdF9pZDogdGVzdF9maWxlLFxyXG4gICAgICAgIGNvbW1vbjoge1xyXG4gICAgICAgICAgICByZXFfcGF0aDogXCJxYVRlc3RcIixcclxuICAgICAgICAgICAgbGV2ZWw6IGN5ZnMuTk9OQVBJTGV2ZWwuTk9OLFxyXG4gICAgICAgICAgICB0YXJnZXQ6IHN0YWNrX3VwbG9hZC5sb2NhbF9kZXZpY2VfaWQoKS5vYmplY3RfaWQsXHJcbiAgICAgICAgICAgIGRlY19pZCxcclxuICAgICAgICAgICAgZmxhZ3M6IDAsXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIGNvbnN0IGdldF9yZXQgPSBhd2FpdCBzdGFja191cGxvYWQubm9uX3NlcnZpY2UoKS5nZXRfb2JqZWN0KHJlcTEpO1xyXG4gICAgbGV0IGZpbGVfb2JqID0gZ2V0X3JldC51bndyYXAoKS5vYmplY3Q7XHJcbiAgICBsZXQgc3RyZWFtID0gYXdhaXQgc3RhY2tfdXBsb2FkLm5vbl9zZXJ2aWNlKCkucHV0X29iamVjdCh7XHJcbiAgICAgICAgY29tbW9uOiB7XHJcbiAgICAgICAgICAgIGRlY19pZCxcclxuICAgICAgICAgICAgZmxhZ3M6IDAsXHJcbiAgICAgICAgICAgIHRhcmdldDogc3RhY2tfZG93bmxvYWQubG9jYWxfZGV2aWNlX2lkKCkub2JqZWN0X2lkLFxyXG4gICAgICAgICAgICBsZXZlbDogY3lmcy5OT05BUElMZXZlbC5Sb3V0ZXIgLy/orr7nva7ot6/nlLHnsbvlnotcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9iamVjdDogbmV3IGN5ZnMuTk9OT2JqZWN0SW5mbyh0ZXN0X2ZpbGUsIGZpbGVfb2JqLm9iamVjdF9yYXcpXHJcbiAgICB9KVxyXG4gICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKGAjIyMjIyAke0pTT04uc3RyaW5naWZ5KHN0cmVhbS51bndyYXAoKS5yZXN1bHQpIH1gKVxyXG4gICAgYXdhaXQgY3lmcy5zbGVlcCgxMDAwKVxyXG4gICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKFwi6I635Y+WdGFzayBvYmplY3RcIik7XHJcbiAgICBjb25zdCByZXEyOiBjeWZzLk5PTkdldE9iamVjdE91dHB1dFJlcXVlc3QgPSB7XHJcbiAgICAgICAgb2JqZWN0X2lkOnRlc3RfZmlsZSxcclxuICAgICAgICBjb21tb246IHtcclxuICAgICAgICAgICAgcmVxX3BhdGg6IFwicWFUZXN0XCIsXHJcbiAgICAgICAgICAgIGxldmVsOiBjeWZzLk5PTkFQSUxldmVsLlJvdXRlcixcclxuICAgICAgICAgICAgdGFyZ2V0IDpzdGFja191cGxvYWQubG9jYWxfZGV2aWNlX2lkKCkub2JqZWN0X2lkLFxyXG4gICAgICAgICAgICBkZWNfaWQsXHJcbiAgICAgICAgICAgIGZsYWdzOiAwLFxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBnZXRfcmV0MiA9IGF3YWl0IHN0YWNrX2Rvd25sb2FkLm5vbl9zZXJ2aWNlKCkuZ2V0X29iamVjdChyZXEyKTtcclxuICAgIGdldF9yZXQyLnVud3JhcCgpLm9iamVjdFxyXG4gICAgbGV0IHNhdmVfZmlsZVBhdGggPSAgcGF0aC5qb2luKCBkb3dubG9hZF9wYXRoLmNhY2hlX3BhdGghLmZpbGVfZG93bmxvYWQhLGNyZWF0ZUZpbGUuZmlsZU5hbWUhKVxyXG4gICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKGAke0pTT04uc3RyaW5naWZ5KGdldF9yZXQyKSB9YClcclxuICAgIGxldCBiZWdpbiA9IERhdGUubm93KCk7XHJcbiAgICBsZXQgZG93bmxvYWQgPSBhd2FpdCBzdGFja19kb3dubG9hZC50cmFucygpLmNyZWF0ZV90YXNrKCB7XHJcbiAgICAgICAgY29tbW9uOiAge1xyXG4gICAgICAgICAgICByZXFfcGF0aDogXCJxYVRlc3RcIixcclxuICAgICAgICAgICAgZGVjX2lkLFxyXG4gICAgICAgICAgICBsZXZlbDogY3lmcy5ORE5BUElMZXZlbC5Sb3V0ZXIsXHJcbiAgICAgICAgICAgIHRhcmdldCA6IHN0YWNrX2Rvd25sb2FkLmxvY2FsX2RldmljZV9pZCgpLm9iamVjdF9pZCxcclxuICAgICAgICAgICAgcmVmZXJlcl9vYmplY3Q6IFtuZXcgY3lmcy5ORE5EYXRhUmVmZXJlck9iamVjdCh0ZXN0X2ZpbGUpXSxcclxuICAgICAgICAgICAgZmxhZ3M6IDEsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvYmplY3RfaWQ6IHRlc3RfZmlsZSxcclxuICAgICAgICBsb2NhbF9wYXRoOiBzYXZlX2ZpbGVQYXRoLFxyXG4gICAgICAgIGRldmljZV9saXN0OiBbc3RhY2tfdXBsb2FkLmxvY2FsX2RldmljZV9pZCgpXSxcclxuICAgICAgICBhdXRvX3N0YXJ0OiB0cnVlLFxyXG4gICAgfSlcclxuICAgIF9pbnRlcmZhY2UuZ2V0TG9nZ2VyKCkuaW5mbyhgIyMke2Rvd25sb2FkfWApXHJcbiAgICBcclxuICAgIGxldCBkb3dubG9hZF9pZCAgPSBkb3dubG9hZC51bndyYXAoKS50YXNrX2lkXHJcbiAgICBmb3IobGV0IGkgPTA7aTx0aW1lb3V0O2krKyl7XHJcbiAgICAgICAgbGV0IHRhc2sgPSBhd2FpdCBzdGFja19kb3dubG9hZC50cmFucygpLmdldF90YXNrX3N0YXRlKCB7XHJcbiAgICAgICAgICAgIGNvbW1vbjogIHtcclxuICAgICAgICAgICAgICAgIHJlcV9wYXRoOiBcInFhVGVzdFwiLFxyXG4gICAgICAgICAgICAgICAgZGVjX2lkLFxyXG4gICAgICAgICAgICAgICAgbGV2ZWw6IGN5ZnMuTkROQVBJTGV2ZWwuUm91dGVyLFxyXG4gICAgICAgICAgICAgICAgcmVmZXJlcl9vYmplY3Q6IFtdLFxyXG4gICAgICAgICAgICAgICAgZmxhZ3M6IDEsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHRhc2tfaWQgOiBkb3dubG9hZF9pZFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKGAjIyMjIyMjIOS8oOi+k+eKtuaAge+8miAke0pTT04uc3RyaW5naWZ5KHRhc2sudW53cmFwKCkpfWAgKTtcclxuICAgICAgICBsZXQgc3RhdGUgPSB0YXNrLnVud3JhcCgpLnN0YXRlO1xyXG4gICAgICAgIGlmKHN0YXRlPT00KXtcclxuICAgICAgICAgICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKGAjIyMjIyMjIOS8oOi+k+WujOaIkO+8miAke0pTT04uc3RyaW5naWZ5KHRhc2sudW53cmFwKCkpfSAsdGltZSA9ICR7RGF0ZS5ub3coKSAtIGJlZ2lufSAs5paH5Lu25aSn5bCPIDogJHtmaWxlU2l6ZX1gICk7XHJcbiAgICAgICAgICAgIHJldHVybiB7ZXJyOkVycm9yQ29kZS5zdWNjLGZpbGVJZDp0ZXN0X2ZpbGUudG9fYmFzZV81OCgpLHRpbWU6RGF0ZS5ub3coKSAtIGJlZ2luLGZpbGVTaXplfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZihzdGF0ZT09NSl7XHJcbiAgICAgICAgICAgIF9pbnRlcmZhY2UuZ2V0TG9nZ2VyKCkuaW5mbyhgIyMjIyMjIyDkvKDovpPlrozmiJDvvJogJHtKU09OLnN0cmluZ2lmeSh0YXNrLnVud3JhcCgpKX0gLHRpbWUgPSAke0RhdGUubm93KCkgLSBiZWdpbn0gLOaWh+S7tuWkp+WwjyA6ICR7ZmlsZVNpemV9YCApO1xyXG4gICAgICAgICAgICByZXR1cm4ge2VycjpFcnJvckNvZGUuZXhjZXB0aW9uLGZpbGVJZDp0ZXN0X2ZpbGUudG9fYmFzZV81OCgpLHRpbWU6RGF0ZS5ub3coKSAtIGJlZ2luLGZpbGVTaXplfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgY3lmcy5zbGVlcCgxMDAwKVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtlcnI6RXJyb3JDb2RlLnRpbWVvdXQsZmlsZUlkOnRlc3RfZmlsZS50b19iYXNlXzU4KCksdGltZTpEYXRlLm5vdygpIC0gYmVnaW4sZmlsZVNpemV9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBUYXNrTWFpbihfaW50ZXJmYWNlOiBUYXNrQ2xpZW50SW50ZXJmYWNlKSB7XHJcblxyXG4gICAgbGV0IGRlY19pZCA9IGN5ZnMuT2JqZWN0SWQuZnJvbV9iYXNlXzU4KFwiOXRHcExObmFiOXVWdGplYUs0Yk01OVFLU2tMRUdXb3cxcEpxNmhqaks5TU1cIikudW53cmFwKCk7XHJcbiAgICBsZXQgRE1DX0Rvd25sb2FkID0gbmV3IFN0YWNrUHJveHlDbGllbnQoe1xyXG4gICAgICAgIF9pbnRlcmZhY2UsXHJcbiAgICAgICAgcGVlck5hbWU6IFwiRE1DX0Rvd25sb2FkXCIsXHJcbiAgICAgICAgc3RhY2tfdHlwZTogXCJvb2RcIixcclxuICAgICAgICB0aW1lb3V0OiA2MCAqIDEwMDAsXHJcbiAgICAgICAgd3NfcG9ydDogMjAwMDEsXHJcbiAgICAgICAgaHR0cF9wb3J0OiAyMDAwMlxyXG4gICAgfSlcclxuICAgIGF3YWl0IERNQ19Eb3dubG9hZC5pbml0KCk7XHJcbiAgICBsZXQgRE1DX1VwbG9hZCA9IG5ldyBTdGFja1Byb3h5Q2xpZW50KHtcclxuICAgICAgICBfaW50ZXJmYWNlLFxyXG4gICAgICAgIHBlZXJOYW1lOiBcIkRNQ19VcGxvYWRcIixcclxuICAgICAgICBzdGFja190eXBlOiBcIm9vZFwiLFxyXG4gICAgICAgIHRpbWVvdXQ6IDYwICogMTAwMCxcclxuICAgICAgICB3c19wb3J0OiAyMDAwMyxcclxuICAgICAgICBodHRwX3BvcnQ6IDIwMDA0XHJcbiAgICB9KVxyXG4gICAgYXdhaXQgRE1DX1VwbG9hZC5pbml0KCk7XHJcbiAgICBcclxuICAgIF9pbnRlcmZhY2UuZ2V0TG9nZ2VyKCkuaW5mbyhgV2FpdGluZyBmb3IgcHJveHkgdG8gY29ubmVjdGlvbi4uLmApO1xyXG4gICAgbGV0IHN0YWNrX2Rvd25sb2FkID0gY3lmcy5TaGFyZWRDeWZzU3RhY2sub3BlbihjeWZzLlNoYXJlZEN5ZnNTdGFja1BhcmFtLm5ld193aXRoX3dzX2V2ZW50X3BvcnRzKDIwMDAyLCAyMDAwMSxkZWNfaWQpLnVud3JhcCgpKVxyXG4gICAgbGV0IHJlc3AgPSBhd2FpdCBzdGFja19kb3dubG9hZC53YWl0X29ubGluZShjeWZzLk5vbmUpO1xyXG4gICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKGB3YWl0X29ubGluZSBmaW5pc2hlZCAke0pTT04uc3RyaW5naWZ5KHJlc3AudW53cmFwKCkpfWApO1xyXG4gICAgbGV0IHJlcyA9IGF3YWl0IHN0YWNrX2Rvd25sb2FkLnV0aWwoKS5nZXRfem9uZSh7IGNvbW1vbjogeyBmbGFnczogMCB9IH0pO1xyXG4gICAgbGV0IHN0YWNrX3VwbG9hZCA9IGN5ZnMuU2hhcmVkQ3lmc1N0YWNrLm9wZW4oY3lmcy5TaGFyZWRDeWZzU3RhY2tQYXJhbS5uZXdfd2l0aF93c19ldmVudF9wb3J0cygyMDAwNCwgMjAwMDMsZGVjX2lkKS51bndyYXAoKSlcclxuICAgIGxldCByZXNwMiA9IGF3YWl0IHN0YWNrX3VwbG9hZC53YWl0X29ubGluZShjeWZzLk5vbmUpO1xyXG4gICAgX2ludGVyZmFjZS5nZXRMb2dnZXIoKS5pbmZvKGB3YWl0X29ubGluZSBmaW5pc2hlZCAke0pTT04uc3RyaW5naWZ5KHJlc3AudW53cmFwKCkpfWApO1xyXG4gICAgbGV0IHJlczIgPSBhd2FpdCBzdGFja191cGxvYWQudXRpbCgpLmdldF96b25lKHsgY29tbW9uOiB7IGZsYWdzOiAwIH0gfSk7XHJcbiAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGVzdF9maWxlKF9pbnRlcmZhY2UsRE1DX0Rvd25sb2FkLERNQ19VcGxvYWQsc3RhY2tfZG93bmxvYWQsc3RhY2tfdXBsb2FkLDUwKjEwMjQqMTAyNCwxMDAwKTtcclxuICAgIGF3YWl0IERNQ19Eb3dubG9hZC51dGlsX2NsaWVudCEuZ2V0U3RhY2tMb2coXCIvY3lmcy9sb2cvZ2F0ZXdheVwiLFwiRE1DX0Rvd25sb2FkXCIpXHJcbiAgICBhd2FpdCBETUNfVXBsb2FkLnV0aWxfY2xpZW50IS5nZXRTdGFja0xvZyhcIi9jeWZzL2xvZy9nYXRld2F5XCIsXCJETUNfRG93bmxvYWRcIilcclxuICAgIGF3YWl0IF9pbnRlcmZhY2UuZXhpdChDbGllbnRFeGl0Q29kZS5mYWlsZWQsIGAke3Jlc3VsdH1gKVxyXG59XHJcbiJdfQ==
