"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StackProxyClient = exports.stringToUint8Array = exports.Uint8ArrayToString = exports.StackError = void 0;
const base_1 = require("../../base");
const events_1 = require("events");
const net_1 = __importDefault(require("net"));
const utilClient_1 = require("./utilClient");
exports.StackError = {
    success: 0,
    LNAgentError: 1,
    RNAgentError: 2,
    reportDataFailed: 3,
    testDataError: 4,
    timeout: 5,
    connect_cyfs_client_faild: 1001,
};
function Uint8ArrayToString(fileData) {
    var dataString = "";
    for (var i = 0; i < fileData.length; i++) {
        dataString += String.fromCharCode(fileData[i]);
    }
    return dataString;
}
exports.Uint8ArrayToString = Uint8ArrayToString;
function stringToUint8Array(str) {
    var arr = [];
    for (var i = 0, j = str.length; i < j; ++i) {
        arr.push(str.charCodeAt(i));
    }
    var tmpUint8Array = new Uint8Array(arr);
    return tmpUint8Array;
}
exports.stringToUint8Array = stringToUint8Array;
class StackProxyClient extends events_1.EventEmitter {
    constructor(options) {
        super();
        this.peerName = options.peerName;
        this.m_interface = options._interface;
        this.stack_type = options.stack_type;
        this.timeout = options.timeout;
        this.log = this.m_interface.getLogger();
        this.state = 0;
        this.ws_port = options.ws_port;
        this.http_port = options.http_port;
    }
    async init() {
        // 连接测试节点
        this.state = 1;
        let agent = await this.m_interface.getAgent({}, [this.peerName], [], [], this.timeout);
        if (agent.err || agent.agentid == undefined) {
            this.log.error(`连接测试节点 ${this.peerName}失败`);
            return { err: exports.StackError.LNAgentError, log: "连接测试节点失败" };
        }
        this.m_agentid = agent.agentid;
        // 测试节点启动测试服务     
        let err = await this.m_interface.startService([], this.m_agentid, this.timeout);
        if (err) {
            this.log.error(`${this.peerName} 测试节点启动服务失败`);
            return { err: exports.StackError.LNAgentError, log: "测试节点启动服务失败" };
        }
        let info = await this.m_interface.callApi('start_client', Buffer.from(''), { stack_type: this.stack_type }, this.m_agentid, 0);
        this.util_client = new utilClient_1.UtilClient(this.m_interface, this.m_agentid, this.peerName, info.value.cacheName);
        this.start_proxy("ws", this.ws_port);
        this.start_proxy("http", this.http_port);
        this.state = 2;
        return { err: base_1.ErrorCode.succ, log: "启动成功" };
    }
    async start_proxy(type, port) {
        let tcpServer = net_1.default.createServer(async (c) => {
            // 这个c 是上层业请求端
            this.log.info(` ${this.peerName} TCP Client ${port} connect ${c.remoteAddress}:${c.remotePort}`);
            // 创建tunnel
            let param = {
                type,
                remoteAddress: c.remoteAddress,
                remotePort: c.remotePort
            };
            let info = await this.m_interface.callApi('build_tunnel', Buffer.from(""), param, this.m_agentid, 0);
            if (info.err) {
                this.log.error(`build_tunnel`);
            }
            // 添加保活探针
            c.setKeepAlive(true, 2000);
            // 监听测试框架事件，返回SDK 报文数据
            let recv_r_req = 0;
            let rnAccept = await this.m_interface.attachEvent(`${c.remoteAddress}_${c.remotePort}`, async (err, namespace, r_req, msg) => {
                this.log.info(` ${this.peerName} TCP Client ${port} write msg ${c.remoteAddress}:${c.remotePort}`);
                // 实现序列化发送, 返回给SDK
                let recheck = 5;
                let msg_u8 = stringToUint8Array(msg);
                c.write(msg_u8);
            }, this.m_agentid);
            let seq = 0;
            c.on('data', async (buf) => {
                this.log.info(` ${this.peerName} TCP Client ${port} read data ${c.remoteAddress}:${c.remotePort}`);
                seq = seq + 1;
                let param = {
                    seq,
                    type,
                    remoteAddress: c.remoteAddress,
                    remotePort: c.remotePort
                };
                let msg_u8 = buf;
                let info = await this.m_interface.callApi('proxy_data', Buffer.from(Uint8ArrayToString(msg_u8)), param, this.m_agentid, 0);
            });
            c.on("end", async () => {
                let info = await this.m_interface.callApi('end_tunnel', Buffer.from(""), param, this.m_agentid, 0);
            });
            c.on('error', async (err) => {
                this.log.info(`${this.peerName} client ${port} proxy error ${err}`);
                await this.m_interface.detachEvent(`${c.remoteAddress}_${c.remotePort}`, rnAccept.cookie);
                this.state = -1;
            });
        });
        tcpServer.listen({ host: "127.0.0.1", port, }, () => {
            this.log.info(`${this.peerName} TCP Server start`);
        });
        return tcpServer;
    }
}
exports.StackProxyClient = StackProxyClient;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlLXRlc3Rlci1hcHAvdGFza1Rvb2xzL2N5ZnNfc3RhY2tfdHVubmVsL3N0YWNrVG9vbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxxQ0FBMko7QUFDM0osbUNBQXNDO0FBQ3RDLDhDQUFzQjtBQUN0Qiw2Q0FBdUM7QUFDMUIsUUFBQSxVQUFVLEdBQUc7SUFDdEIsT0FBTyxFQUFFLENBQUM7SUFDVixZQUFZLEVBQUUsQ0FBQztJQUNmLFlBQVksRUFBRSxDQUFDO0lBQ2YsZ0JBQWdCLEVBQUUsQ0FBQztJQUNuQixhQUFhLEVBQUUsQ0FBQztJQUNoQixPQUFPLEVBQUUsQ0FBQztJQUNWLHlCQUF5QixFQUFFLElBQUk7Q0FDbEMsQ0FBQTtBQUNELFNBQWdCLGtCQUFrQixDQUFDLFFBQW9CO0lBQ25ELElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQztJQUNwQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN0QyxVQUFVLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNsRDtJQUNELE9BQU8sVUFBVSxDQUFBO0FBQ3JCLENBQUM7QUFORCxnREFNQztBQUNELFNBQWdCLGtCQUFrQixDQUFDLEdBQVc7SUFDMUMsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO0lBQ2IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRTtRQUN4QyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUMvQjtJQUNELElBQUksYUFBYSxHQUFHLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLE9BQU8s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SSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFeEcsQ0FBQyxDQUFDLENBQUE7WUFDRixDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsV0FBVyxJQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQyxDQUFBO2dCQUNuRSxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGFBQWEsSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsUUFBUSxDQUFDLE1BQU8sQ0FBQyxDQUFBO2dCQUMxRixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7UUFDSCxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUU7WUFDaEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxtQkFBbUIsQ0FBQyxDQUFBO1FBQ3RELENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQztDQUNKO0FBMUdELDRDQTBHQyIsImZpbGUiOiJ0YXNrVG9vbHMvY3lmc19zdGFja190dW5uZWwvc3RhY2tUb29sLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXJyb3JDb2RlLCBOZXRFbnRyeSwgTmFtZXNwYWNlLCBBY2Nlc3NOZXRUeXBlLCBCdWZmZXJSZWFkZXIsIExvZ2dlciwgVGFza0NsaWVudEludGVyZmFjZSwgQ2xpZW50RXhpdENvZGUsIEJ1ZmZlcldyaXRlciwgc2xlZXAgfSBmcm9tICcuLi8uLi9iYXNlJztcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcclxuaW1wb3J0IG5ldCBmcm9tIFwibmV0XCI7XHJcbmltcG9ydCB7VXRpbENsaWVudH0gZnJvbSBcIi4vdXRpbENsaWVudFwiXHJcbmV4cG9ydCBjb25zdCBTdGFja0Vycm9yID0ge1xyXG4gICAgc3VjY2VzczogMCwgLy/miafooYzmiJDlip9cclxuICAgIExOQWdlbnRFcnJvcjogMSwgLy/mtYvor5XmoYbmnrbov57mjqXmtYvor5Xorr7lpIfmiqXplJlcclxuICAgIFJOQWdlbnRFcnJvcjogMiwgLy/mtYvor5XmoYbmnrbov57mjqXmtYvor5Xorr7lpIfmiqXplJlcclxuICAgIHJlcG9ydERhdGFGYWlsZWQ6IDMsIC8v5oql5a2Y5rWL6K+V5pWw5o2u5oql6ZSZXHJcbiAgICB0ZXN0RGF0YUVycm9yOiA0LC8v5L2/55So5rWL6K+V5pWw5o2u5qCh6aqM5aSx6LSl5oql6ZSZXHJcbiAgICB0aW1lb3V0OiA1LCAvL+aJp+ihjOeUqOS+i+i2heaXtuaKpemUmVxyXG4gICAgY29ubmVjdF9jeWZzX2NsaWVudF9mYWlsZDogMTAwMSxcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gVWludDhBcnJheVRvU3RyaW5nKGZpbGVEYXRhOiBVaW50OEFycmF5KSB7XHJcbiAgICB2YXIgZGF0YVN0cmluZyA9IFwiXCI7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVEYXRhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgZGF0YVN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGZpbGVEYXRhW2ldKTtcclxuICAgIH1cclxuICAgIHJldHVybiBkYXRhU3RyaW5nXHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ1RvVWludDhBcnJheShzdHI6IHN0cmluZykge1xyXG4gICAgdmFyIGFyciA9IFtdO1xyXG4gICAgZm9yICh2YXIgaSA9IDAsIGogPSBzdHIubGVuZ3RoOyBpIDwgajsgKytpKSB7XHJcbiAgICAgICAgYXJyLnB1c2goc3RyLmNoYXJDb2RlQXQoaSkpO1xyXG4gICAgfVxyXG4gICAgdmFyIHRtcFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShhcnIpO1xyXG4gICAgcmV0dXJuIHRtcFVpbnQ4QXJyYXlcclxufVxyXG5leHBvcnQgY2xhc3MgU3RhY2tQcm94eUNsaWVudCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgICBwcml2YXRlIHBlZXJOYW1lOiBzdHJpbmc7IC8vIOa1i+ivleiKgueCueagh+etvlxyXG4gICAgcHJpdmF0ZSBzdGFja190eXBlOiBzdHJpbmc7ICAvLyDmtYvor5XoioLngrnljY/orq7moIjnsbvlnotcclxuICAgIHByaXZhdGUgc3RhdGU6IG51bWJlcjsgLy8gMCDmnKrliJ3lp4sgMSDliJ3lp4vljJbkuK0gMiDlj6/kvb/nlKggLTEg6ZSA5q+BXHJcbiAgICBwdWJsaWMgdXRpbF9jbGllbnQ/IDogVXRpbENsaWVudDtcclxuICAgIHByaXZhdGUgbV9hZ2VudGlkPzogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSB3c19wb3J0OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIGh0dHBfcG9ydDogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSB0aW1lb3V0OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIGxvZzogTG9nZ2VyO1xyXG4gICAgcHJpdmF0ZSBtX2ludGVyZmFjZTogVGFza0NsaWVudEludGVyZmFjZTtcclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IHtcclxuICAgICAgICBfaW50ZXJmYWNlOiBUYXNrQ2xpZW50SW50ZXJmYWNlO1xyXG4gICAgICAgIHBlZXJOYW1lOiBzdHJpbmc7XHJcbiAgICAgICAgc3RhY2tfdHlwZTogc3RyaW5nO1xyXG4gICAgICAgIHRpbWVvdXQ6IG51bWJlcjtcclxuICAgICAgICB3c19wb3J0OiBudW1iZXI7XHJcbiAgICAgICAgaHR0cF9wb3J0OiBudW1iZXI7XHJcbiAgICB9KSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLnBlZXJOYW1lID0gb3B0aW9ucy5wZWVyTmFtZTtcclxuICAgICAgICB0aGlzLm1faW50ZXJmYWNlID0gb3B0aW9ucy5faW50ZXJmYWNlO1xyXG4gICAgICAgIHRoaXMuc3RhY2tfdHlwZSA9IG9wdGlvbnMuc3RhY2tfdHlwZTtcclxuICAgICAgICB0aGlzLnRpbWVvdXQgPSBvcHRpb25zLnRpbWVvdXQ7XHJcbiAgICAgICAgdGhpcy5sb2cgPSB0aGlzLm1faW50ZXJmYWNlLmdldExvZ2dlcigpO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSAwO1xyXG4gICAgICAgIHRoaXMud3NfcG9ydCA9IG9wdGlvbnMud3NfcG9ydDtcclxuICAgICAgICB0aGlzLmh0dHBfcG9ydCA9IG9wdGlvbnMuaHR0cF9wb3J0O1xyXG4gICAgfVxyXG4gICAgYXN5bmMgaW5pdCgpOiBQcm9taXNlPHsgZXJyOiBFcnJvckNvZGUsIGxvZz86IHN0cmluZyB9PiB7XHJcbiAgICAgICAgLy8g6L+e5o6l5rWL6K+V6IqC54K5XHJcbiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7XHJcbiAgICAgICAgbGV0IGFnZW50ID0gYXdhaXQgdGhpcy5tX2ludGVyZmFjZS5nZXRBZ2VudCh7fSBhcyBhbnksIFt0aGlzLnBlZXJOYW1lXSwgW10sIFtdLCB0aGlzLnRpbWVvdXQpO1xyXG4gICAgICAgIGlmIChhZ2VudC5lcnIgfHwgYWdlbnQuYWdlbnRpZCA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYOi/nuaOpea1i+ivleiKgueCuSAke3RoaXMucGVlck5hbWV95aSx6LSlYClcclxuICAgICAgICAgICAgcmV0dXJuIHsgZXJyOiBTdGFja0Vycm9yLkxOQWdlbnRFcnJvciwgbG9nOiBcIui/nuaOpea1i+ivleiKgueCueWksei0pVwiIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5tX2FnZW50aWQgPSBhZ2VudC5hZ2VudGlkITtcclxuICAgICAgICAvLyDmtYvor5XoioLngrnlkK/liqjmtYvor5XmnI3liqEgICAgIFxyXG4gICAgICAgIGxldCBlcnIgPSBhd2FpdCB0aGlzLm1faW50ZXJmYWNlLnN0YXJ0U2VydmljZShbXSwgdGhpcy5tX2FnZW50aWQsIHRoaXMudGltZW91dCk7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLnBlZXJOYW1lfSDmtYvor5XoioLngrnlkK/liqjmnI3liqHlpLHotKVgKVxyXG4gICAgICAgICAgICByZXR1cm4geyBlcnI6IFN0YWNrRXJyb3IuTE5BZ2VudEVycm9yLCBsb2c6IFwi5rWL6K+V6IqC54K55ZCv5Yqo5pyN5Yqh5aSx6LSlXCIgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgaW5mbyA9IGF3YWl0IHRoaXMubV9pbnRlcmZhY2UuY2FsbEFwaSgnc3RhcnRfY2xpZW50JywgQnVmZmVyLmZyb20oJycpLCB7IHN0YWNrX3R5cGU6IHRoaXMuc3RhY2tfdHlwZSB9LCB0aGlzLm1fYWdlbnRpZCEsIDApO1xyXG4gICAgICAgIHRoaXMudXRpbF9jbGllbnQgPSBuZXcgVXRpbENsaWVudCh0aGlzLm1faW50ZXJmYWNlLHRoaXMubV9hZ2VudGlkLHRoaXMucGVlck5hbWUsaW5mby52YWx1ZS5jYWNoZU5hbWUpO1xyXG4gICAgICAgIHRoaXMuc3RhcnRfcHJveHkoXCJ3c1wiLCB0aGlzLndzX3BvcnQpO1xyXG4gICAgICAgIHRoaXMuc3RhcnRfcHJveHkoXCJodHRwXCIsIHRoaXMuaHR0cF9wb3J0KTtcclxuICAgICAgICB0aGlzLnN0YXRlID0gMjtcclxuICAgICAgICByZXR1cm4geyBlcnI6IEVycm9yQ29kZS5zdWNjLCBsb2c6IFwi5ZCv5Yqo5oiQ5YqfXCIgfVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHN0YXJ0X3Byb3h5KHR5cGU6IHN0cmluZywgcG9ydDogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IHRjcFNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoYXN5bmMgKGMpID0+IHtcclxuICAgICAgICAgICAgLy8g6L+Z5LiqYyDmmK/kuIrlsYLkuJror7fmsYLnq69cclxuICAgICAgICAgICAgdGhpcy5sb2cuaW5mbyhgICR7dGhpcy5wZWVyTmFtZX0gVENQIENsaWVudCAke3BvcnR9IGNvbm5lY3QgJHtjLnJlbW90ZUFkZHJlc3N9OiR7Yy5yZW1vdGVQb3J0fWApO1xyXG4gICAgICAgICAgICAvLyDliJvlu7p0dW5uZWxcclxuICAgICAgICAgICAgbGV0IHBhcmFtID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZSxcclxuICAgICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IGMucmVtb3RlQWRkcmVzcyxcclxuICAgICAgICAgICAgICAgIHJlbW90ZVBvcnQ6IGMucmVtb3RlUG9ydFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBpbmZvID0gYXdhaXQgdGhpcy5tX2ludGVyZmFjZS5jYWxsQXBpKCdidWlsZF90dW5uZWwnLCBCdWZmZXIuZnJvbShcIlwiKSwgcGFyYW0sIHRoaXMubV9hZ2VudGlkISwgMCk7XHJcbiAgICAgICAgICAgIGlmIChpbmZvLmVycikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYGJ1aWxkX3R1bm5lbGApXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8g5re75Yqg5L+d5rS75o6i6ZKIXHJcbiAgICAgICAgICAgIGMuc2V0S2VlcEFsaXZlKHRydWUsMjAwMClcclxuICAgICAgICAgICAgLy8g55uR5ZCs5rWL6K+V5qGG5p625LqL5Lu277yM6L+U5ZueU0RLIOaKpeaWh+aVsOaNrlxyXG4gICAgICAgICAgICBsZXQgcmVjdl9yX3JlcSA9IDA7XHJcbiAgICAgICAgICAgIGxldCBybkFjY2VwdCA9IGF3YWl0IHRoaXMubV9pbnRlcmZhY2UuYXR0YWNoRXZlbnQoYCR7Yy5yZW1vdGVBZGRyZXNzfV8ke2MucmVtb3RlUG9ydH1gLCBhc3luYyAoZXJyOiBFcnJvckNvZGUsIG5hbWVzcGFjZTogTmFtZXNwYWNlLCByX3JlcTogbnVtYmVyLCBtc2c6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuaW5mbyhgICR7dGhpcy5wZWVyTmFtZX0gVENQIENsaWVudCAke3BvcnR9IHdyaXRlIG1zZyAke2MucmVtb3RlQWRkcmVzc306JHtjLnJlbW90ZVBvcnR9YCk7XHJcbiAgICAgICAgICAgICAgICAvLyDlrp7njrDluo/liJfljJblj5HpgIEsIOi/lOWbnue7mVNES1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlY2hlY2sgPSA1O1xyXG4gICAgICAgICAgICAgICAgbGV0IG1zZ191OCA9IHN0cmluZ1RvVWludDhBcnJheShtc2cpO1xyXG4gICAgICAgICAgICAgICAgYy53cml0ZShtc2dfdTgpO1xyXG5cclxuICAgICAgICAgICAgfSwgdGhpcy5tX2FnZW50aWQhKTtcclxuICAgICAgICAgICAgbGV0IHNlcSA9IDA7XHJcbiAgICAgICAgICAgIGMub24oJ2RhdGEnLCBhc3luYyAoYnVmKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5pbmZvKGAgJHt0aGlzLnBlZXJOYW1lfSBUQ1AgQ2xpZW50ICR7cG9ydH0gcmVhZCBkYXRhICR7Yy5yZW1vdGVBZGRyZXNzfToke2MucmVtb3RlUG9ydH1gKTtcclxuICAgICAgICAgICAgICAgIHNlcSA9IHNlcSArIDE7XHJcbiAgICAgICAgICAgICAgICBsZXQgcGFyYW0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VxLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogYy5yZW1vdGVBZGRyZXNzLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbW90ZVBvcnQ6IGMucmVtb3RlUG9ydFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbGV0IG1zZ191OCA9IGJ1ZiBhcyBVaW50OEFycmF5O1xyXG4gICAgICAgICAgICAgICAgbGV0IGluZm8gPSBhd2FpdCB0aGlzLm1faW50ZXJmYWNlLmNhbGxBcGkoJ3Byb3h5X2RhdGEnLCBCdWZmZXIuZnJvbShVaW50OEFycmF5VG9TdHJpbmcobXNnX3U4KSksIHBhcmFtLCB0aGlzLm1fYWdlbnRpZCEsIDApO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICBjLm9uKFwiZW5kXCIsYXN5bmMgKCk9PntcclxuICAgICAgICAgICAgICAgIGxldCBpbmZvID0gYXdhaXQgdGhpcy5tX2ludGVyZmFjZS5jYWxsQXBpKCdlbmRfdHVubmVsJywgQnVmZmVyLmZyb20oXCJcIiksIHBhcmFtLCB0aGlzLm1fYWdlbnRpZCEsIDApO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIGMub24oJ2Vycm9yJywgYXN5bmMgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuaW5mbyhgJHt0aGlzLnBlZXJOYW1lfSBjbGllbnQgJHtwb3J0fSBwcm94eSBlcnJvciAke2Vycn1gKVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5tX2ludGVyZmFjZS5kZXRhY2hFdmVudChgJHtjLnJlbW90ZUFkZHJlc3N9XyR7Yy5yZW1vdGVQb3J0fWAsIHJuQWNjZXB0LmNvb2tpZSEpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gLTE7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRjcFNlcnZlci5saXN0ZW4oeyBob3N0OiBcIjEyNy4wLjAuMVwiLCBwb3J0LCB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9nLmluZm8oYCR7dGhpcy5wZWVyTmFtZX0gVENQIFNlcnZlciBzdGFydGApXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHRjcFNlcnZlcjtcclxuICAgIH1cclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuIl19
