"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const path = __importStar(require("path"));
const account_profile_1 = require("../script/account_profile");
const ChildProcess = __importStar(require("child_process"));
const base_1 = require("../base");
const os = __importStar(require("os"));
const fs = __importStar(require("fs-extra"));
class Runner {
    constructor(options) {
        this.m_latestRecvTime = 0;
        this.m_account = options.account;
        this.m_reporter = options.reporter;
        this.m_version = options.version;
        this.m_updateHost = options.updateHost;
        this.m_updatePort = options.updatePort;
        this.m_deviceIdSave = options.deviceIdSave;
        this.m_platform = options.platform;
    }
    get process() {
        return this.m_process;
    }
    async getDeviceID() {
        let id = '';
        let info = await this.m_deviceIdSave.get('deviceId');
        if (info.err || !info.value || !info.value.length) {
            if (this.m_account.deviceID) {
                id = this.m_account.deviceID;
            }
            else if (this.m_account.peerid) {
                id = this.m_account.peerid;
            }
            if (id.length) {
                await this.m_deviceIdSave.set('deviceId', id);
            }
        }
        else {
            id = info.value;
        }
        return id;
    }
    async start() {
        await this.m_deviceIdSave.load();
        await this._startLocalMaster();
        this.TaskRunMonitor();
    }
    async TaskRunMonitor() {
        let runConfig = path.join(base_1.DirHelper.getLogDir(), "running.pid");
        let check = 0;
        while (check < 10) {
            if (fs.existsSync(runConfig)) {
                check = 0;
            }
            else {
                check + check + 1;
            }
            await base_1.sleep(3000);
        }
        process.exit(0);
    }
    async check_state() {
        let runConfig = path.join(base_1.DirHelper.getLogDir(), "running.pid");
        while (fs.existsSync(runConfig)) {
            await base_1.sleep(5 * 1000);
        }
    }
    async _startLocalMaster() {
        if (this.m_process) {
            return;
        }
        let entryfile = path.join(path.dirname(process.argv[1]), '../script/master_main.js');
        let deviceID = await this.getDeviceID();
        this.m_process = ChildProcess.fork(entryfile, [base_1.DirHelper.getRootDir(), deviceID, this.m_platform, '1'], { silent: true });
        this.state = "run";
        this.m_process.on('exit', (code, signal) => {
            this.state = "exit";
            if (this.m_sendMsgTimer) {
                clearInterval(this.m_sendMsgTimer);
                this.m_sendMsgTimer = undefined;
            }
            console.log(`[startup] service exit, code=${code}, signal=${signal}`);
            this.m_process = undefined;
            process.exit(0);
        });
        this.m_latestRecvTime = Date.now();
        this.m_sendMsgTimer = setInterval(() => {
            this.m_process.send('keeplive');
            if (Date.now() - this.m_latestRecvTime > 20 * 1000) {
                process.exit(0);
            }
        }, 2000);
        this.m_process.stdout.on('data', (data) => {
            console.info(`recv data from client ${String(data)}`);
            if (String(data) == "exit") {
                process.exit(0);
            }
            this.m_latestRecvTime = Date.now();
        });
    }
    async _stopLocalMaster() {
        if (!this.m_process) {
            return;
        }
        await new Promise((v) => {
            this.m_process.once('exit', () => {
                v("");
            });
            // this.m_process!.stdout.removeAllListeners();
            this.m_process.kill();
        });
    }
}
async function main() {
    process.chdir(path.dirname(process.argv[1]));
    let dir = path.dirname(path.dirname(process.argv[1]));
    console.log(`${dir}`);
    base_1.DirHelper.setRootDir(dir);
    let logFolder = base_1.DirHelper.getLogDir();
    base_1.DirHelper.emptyDir(logFolder);
    base_1.DirHelper.emptyDir(base_1.DirHelper.getTempDir());
    base_1.FileUploader.getInstance().init(base_1.GlobalConfig.fileUploadServer.host, base_1.GlobalConfig.fileUploadServer.port);
    let account = new account_profile_1.AccountStatusProfile();
    await account.load();
    if (!account.accountID || account.accountID.length === 0) {
        account.accountID = process.argv[2];
    }
    if (!account.peerid || account.peerid.length === 0) {
        account.peerid = `${account.accountID}-${base_1.RandomGenerator.string(8)}`;
    }
    account.errorMsg = '正在连接服务器';
    account.save();
    let reporter = new base_1.Reporter(base_1.GlobalConfig.reportServer.host, base_1.GlobalConfig.reportServer.port, account.peerid, base_1.GlobalConfig.version);
    let loggerFun = (info) => {
        console.log(info);
    };
    let logger = new base_1.Logger(loggerFun, loggerFun, loggerFun, logFolder);
    let deviceIdSave = new base_1.LocalStorageJson({
        file: path.join(base_1.DirHelper.getConfigDir(), 'deviceId.json'),
        logger
    });
    let runner = new Runner({
        account,
        reporter,
        version: base_1.GlobalConfig.version,
        updateHost: base_1.GlobalConfig.updateServer.host,
        updatePort: base_1.GlobalConfig.updateServer.port,
        deviceIdSave,
        platform: os.platform(),
    });
    await runner.start();
    // const serviceid = "4402";
    // const taskList = [
    //     "Connect_FristQA_TCP_direct",
    //     "Connect_FristQA_TCP_SN",
    //     "Connect_FristQA_TCP_PackageSize_answer",
    //     "Connect_FristQA_TCP_PackageSize_quesyion",
    //     "Connect_FristQA_UDP_direct",
    //     "Connect_FristQA_UDP_SN",
    //     "Connect_FristQA_UDP_PackageSize_answer",
    //     "Connect_FristQA_UDP_PackageSize_question",
    // ]
    const serviceid = "564150";
    const taskList = [
        "DMC_debuger_50MB",
    ];
    for (let i = 0; i < 10000; i++) {
        taskList.push("DMC_debuger_500MB");
    }
    for (let i in taskList) {
        let runConfig = path.join(base_1.DirHelper.getLogDir(), "running.pid");
        if (!fs.existsSync(runConfig)) {
            fs.createFileSync(runConfig);
        }
        let taskid = taskList[i];
        let str = JSON.stringify({ serviceid, taskid });
        runner.process.send(str);
        await runner.check_state();
    }
    process.exit(0);
}
main();

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlLXRlc3Rlci1hcHAvaG9zdC90b29sX3J1bi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFDN0IsK0RBQStEO0FBQy9ELDREQUE4QztBQUM5QyxrQ0FBNEg7QUFFNUgsdUNBQXlCO0FBRXpCLDZDQUE4QjtBQVc5QixNQUFNLE1BQU07SUFhUixZQUFZLE9BQXNCO1FBUHhCLHFCQUFnQixHQUFXLENBQUMsQ0FBQztRQVFuQyxJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDakMsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDO1FBQ25DLElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUNqQyxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFDdkMsSUFBSSxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUMzQyxJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7SUFDdkMsQ0FBQztJQUVELElBQUksT0FBTztRQUNQLE9BQU8sSUFBSSxDQUFDLFNBQVUsQ0FBQztJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVc7UUFDYixJQUFJLEVBQUUsR0FBVyxFQUFFLENBQUM7UUFDcEIsSUFBSSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNyRCxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQU0sQ0FBQyxNQUFNLEVBQUU7WUFDaEQsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRTtnQkFDekIs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LElBQUksRUFBRSxDQUFDIiwiZmlsZSI6Imhvc3QvdG9vbF9ydW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQge0FjY291bnRTdGF0dXNQcm9maWxlfSBmcm9tICcuLi9zY3JpcHQvYWNjb3VudF9wcm9maWxlJztcclxuaW1wb3J0ICogYXMgQ2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5pbXBvcnQgeyBSZXBvcnRlciwgRGlySGVscGVyLCBGaWxlVXBsb2FkZXIsIEdsb2JhbENvbmZpZywgUmFuZG9tR2VuZXJhdG9yLCBMb2NhbFN0b3JhZ2VKc29uLCBMb2dnZXIsIHNsZWVwIH0gZnJvbSAnLi4vYmFzZSc7XHJcbmltcG9ydCAqIGFzIHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcclxuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xyXG5pbXBvcnQgeyBmc09wZW5GaWxlcyB9IGZyb20gJ3N5c3RlbWluZm9ybWF0aW9uJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCJcclxudHlwZSBSdW5uZXJPcHRpb25zID0ge1xyXG4gICAgYWNjb3VudDogQWNjb3VudFN0YXR1c1Byb2ZpbGU7XHJcbiAgICByZXBvcnRlcjogUmVwb3J0ZXI7XHJcbiAgICB2ZXJzaW9uOiBzdHJpbmc7XHJcbiAgICB1cGRhdGVIb3N0OiBzdHJpbmc7XHJcbiAgICB1cGRhdGVQb3J0OiBudW1iZXI7XHJcbiAgICBkZXZpY2VJZFNhdmU6IExvY2FsU3RvcmFnZUpzb247XHJcbiAgICBwbGF0Zm9ybTogc3RyaW5nO1xyXG59XHJcblxyXG5jbGFzcyBSdW5uZXIge1xyXG4gICAgcHJpdmF0ZSBtX2FjY291bnQ6IEFjY291bnRTdGF0dXNQcm9maWxlO1xyXG4gICAgcHJpdmF0ZSBtX3JlcG9ydGVyOiBSZXBvcnRlcjtcclxuICAgIHByaXZhdGUgbV92ZXJzaW9uOiBzdHJpbmc7XHJcbiAgICBwcm90ZWN0ZWQgbV9wcm9jZXNzPzogQ2hpbGRQcm9jZXNzLkNoaWxkUHJvY2VzcztcclxuICAgIHByb3RlY3RlZCBtX3NlbmRNc2dUaW1lcj86IE5vZGVKUy5UaW1lcjtcclxuICAgIHByb3RlY3RlZCBtX2xhdGVzdFJlY3ZUaW1lOiBudW1iZXIgPSAwO1xyXG4gICAgcHJvdGVjdGVkIG1fdXBkYXRlSG9zdDogc3RyaW5nO1xyXG4gICAgcHJvdGVjdGVkIG1fdXBkYXRlUG9ydDogbnVtYmVyO1xyXG4gICAgcHJvdGVjdGVkIG1fZGV2aWNlSWRTYXZlOiBMb2NhbFN0b3JhZ2VKc29uO1xyXG4gICAgcHJvdGVjdGVkIG1fcGxhdGZvcm06IHN0cmluZztcclxuICAgIHByaXZhdGUgc3RhdGU/IDogc3RyaW5nO1xyXG4gICAgXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBSdW5uZXJPcHRpb25zKSB7XHJcbiAgICAgICAgdGhpcy5tX2FjY291bnQgPSBvcHRpb25zLmFjY291bnQ7XHJcbiAgICAgICAgdGhpcy5tX3JlcG9ydGVyID0gb3B0aW9ucy5yZXBvcnRlcjtcclxuICAgICAgICB0aGlzLm1fdmVyc2lvbiA9IG9wdGlvbnMudmVyc2lvbjtcclxuICAgICAgICB0aGlzLm1fdXBkYXRlSG9zdCA9IG9wdGlvbnMudXBkYXRlSG9zdDtcclxuICAgICAgICB0aGlzLm1fdXBkYXRlUG9ydCA9IG9wdGlvbnMudXBkYXRlUG9ydDtcclxuICAgICAgICB0aGlzLm1fZGV2aWNlSWRTYXZlID0gb3B0aW9ucy5kZXZpY2VJZFNhdmU7XHJcbiAgICAgICAgdGhpcy5tX3BsYXRmb3JtID0gb3B0aW9ucy5wbGF0Zm9ybTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcHJvY2VzcygpOiBDaGlsZFByb2Nlc3MuQ2hpbGRQcm9jZXNzIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tX3Byb2Nlc3MhO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGdldERldmljZUlEKCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgbGV0IGlkOiBzdHJpbmcgPSAnJztcclxuICAgICAgICBsZXQgaW5mbyA9IGF3YWl0IHRoaXMubV9kZXZpY2VJZFNhdmUuZ2V0KCdkZXZpY2VJZCcpO1xyXG4gICAgICAgIGlmIChpbmZvLmVyciB8fCAhaW5mby52YWx1ZSB8fCAhaW5mby52YWx1ZSEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm1fYWNjb3VudC5kZXZpY2VJRCkge1xyXG4gICAgICAgICAgICAgICAgaWQgPSB0aGlzLm1fYWNjb3VudC5kZXZpY2VJRDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1fYWNjb3VudC5wZWVyaWQpIHtcclxuICAgICAgICAgICAgICAgIGlkID0gdGhpcy5tX2FjY291bnQucGVlcmlkO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaWQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLm1fZGV2aWNlSWRTYXZlLnNldCgnZGV2aWNlSWQnLCBpZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZCA9IGluZm8udmFsdWUhO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGlkO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHN0YXJ0KCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMubV9kZXZpY2VJZFNhdmUubG9hZCgpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuX3N0YXJ0TG9jYWxNYXN0ZXIoKTtcclxuICAgICAgICB0aGlzLlRhc2tSdW5Nb25pdG9yKClcclxuICAgICAgICBcclxuICAgIH1cclxuICAgIGFzeW5jIFRhc2tSdW5Nb25pdG9yKCl7XHJcbiAgICAgICAgbGV0IHJ1bkNvbmZpZyA9IHBhdGguam9pbihEaXJIZWxwZXIuZ2V0TG9nRGlyKCksXCJydW5uaW5nLnBpZFwiKVxyXG4gICAgICAgIGxldCBjaGVjayA9IDBcclxuICAgICAgICB3aGlsZShjaGVjazwxMCl7XHJcbiAgICAgICAgICAgIGlmKGZzLmV4aXN0c1N5bmMocnVuQ29uZmlnKSl7XHJcbiAgICAgICAgICAgICAgICBjaGVjayA9IDA7XHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgY2hlY2sgKyBjaGVjayArIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXdhaXQgc2xlZXAoMzAwMClcclxuICAgICAgICB9XHJcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xyXG4gICAgfVxyXG4gICAgYXN5bmMgY2hlY2tfc3RhdGUoKXtcclxuICAgICAgICBsZXQgcnVuQ29uZmlnID0gcGF0aC5qb2luKERpckhlbHBlci5nZXRMb2dEaXIoKSxcInJ1bm5pbmcucGlkXCIpXHJcbiAgICAgICAgd2hpbGUoZnMuZXhpc3RzU3luYyhydW5Db25maWcpKXtcclxuICAgICAgICAgICAgYXdhaXQgc2xlZXAoNSoxMDAwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGFzeW5jIF9zdGFydExvY2FsTWFzdGVyKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm1fcHJvY2Vzcykge1xyXG4gICAgICAgICAgICByZXR1cm4gO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgZW50cnlmaWxlOiBzdHJpbmcgPSBwYXRoLmpvaW4ocGF0aC5kaXJuYW1lKHByb2Nlc3MuYXJndlsxXSksICcuLi9zY3JpcHQvbWFzdGVyX21haW4uanMnKTtcclxuICAgICAgICBsZXQgZGV2aWNlSUQ6IHN0cmluZyA9IGF3YWl0IHRoaXMuZ2V0RGV2aWNlSUQoKTtcclxuICAgICAgICB0aGlzLm1fcHJvY2VzcyA9IENoaWxkUHJvY2Vzcy5mb3JrKGVudHJ5ZmlsZSwgW0RpckhlbHBlci5nZXRSb290RGlyKCksIGRldmljZUlELCB0aGlzLm1fcGxhdGZvcm0sICcxJ10sIHsgc2lsZW50OiB0cnVlIH0pO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBcInJ1blwiXHJcbiAgICAgICAgdGhpcy5tX3Byb2Nlc3Mub24oJ2V4aXQnLCAoY29kZTogbnVtYmVyLCBzaWduYWw6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlID0gXCJleGl0XCJcclxuICAgICAgICAgICAgaWYgKHRoaXMubV9zZW5kTXNnVGltZXIpIHtcclxuICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5tX3NlbmRNc2dUaW1lcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1fc2VuZE1zZ1RpbWVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW3N0YXJ0dXBdIHNlcnZpY2UgZXhpdCwgY29kZT0ke2NvZGV9LCBzaWduYWw9JHtzaWduYWx9YCk7XHJcbiAgICAgICAgICAgIHRoaXMubV9wcm9jZXNzID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLm1fbGF0ZXN0UmVjdlRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRoaXMubV9zZW5kTXNnVGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubV9wcm9jZXNzIS5zZW5kKCdrZWVwbGl2ZScpO1xyXG4gICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMubV9sYXRlc3RSZWN2VGltZSA+IDIwICogMTAwMCkge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgMjAwMCk7XHJcblxyXG4gICAgICAgIHRoaXMubV9wcm9jZXNzIS5zdGRvdXQhLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5pbmZvKGByZWN2IGRhdGEgZnJvbSBjbGllbnQgJHtTdHJpbmcoZGF0YSl9YClcclxuICAgICAgICAgICAgaWYoU3RyaW5nKGRhdGEpPT1cImV4aXRcIil7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5tX2xhdGVzdFJlY3ZUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgYXN5bmMgX3N0b3BMb2NhbE1hc3RlcigpIHtcclxuICAgICAgICBpZiAoIXRoaXMubV9wcm9jZXNzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKCh2KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubV9wcm9jZXNzIS5vbmNlKCdleGl0JywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdihcIlwiKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgIC8vIHRoaXMubV9wcm9jZXNzIS5zdGRvdXQucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XHJcbiAgICAgICAgICAgIHRoaXMubV9wcm9jZXNzIS5raWxsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIG1haW4oKSB7XHJcbiAgICBwcm9jZXNzLmNoZGlyKHBhdGguZGlybmFtZShwcm9jZXNzLmFyZ3ZbMV0pKTtcclxuICAgIGxldCBkaXIgPSBwYXRoLmRpcm5hbWUocGF0aC5kaXJuYW1lKHByb2Nlc3MuYXJndlsxXSkpO1xyXG4gICAgY29uc29sZS5sb2coYCR7ZGlyfWApO1xyXG4gICAgRGlySGVscGVyLnNldFJvb3REaXIoZGlyKTtcclxuICAgIGxldCBsb2dGb2xkZXIgPSBEaXJIZWxwZXIuZ2V0TG9nRGlyKCk7XHJcbiAgICBEaXJIZWxwZXIuZW1wdHlEaXIobG9nRm9sZGVyKTtcclxuICAgIERpckhlbHBlci5lbXB0eURpcihEaXJIZWxwZXIuZ2V0VGVtcERpcigpKTtcclxuICAgIFxyXG4gICAgRmlsZVVwbG9hZGVyLmdldEluc3RhbmNlKCkuaW5pdChHbG9iYWxDb25maWcuZmlsZVVwbG9hZFNlcnZlci5ob3N0LCBHbG9iYWxDb25maWcuZmlsZVVwbG9hZFNlcnZlci5wb3J0KTtcclxuXHJcbiAgICBsZXQgYWNjb3VudDogQWNjb3VudFN0YXR1c1Byb2ZpbGUgPSBuZXcgQWNjb3VudFN0YXR1c1Byb2ZpbGUoKTtcclxuICAgIGF3YWl0IGFjY291bnQubG9hZCgpO1xyXG4gICAgaWYgKCFhY2NvdW50LmFjY291bnRJRCB8fCBhY2NvdW50LmFjY291bnRJRC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBhY2NvdW50LmFjY291bnRJRCA9IHByb2Nlc3MuYXJndlsyXTtcclxuICAgIH1cclxuICAgIGlmICghYWNjb3VudC5wZWVyaWQgfHwgYWNjb3VudC5wZWVyaWQubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgYWNjb3VudC5wZWVyaWQgPSBgJHthY2NvdW50LmFjY291bnRJRH0tJHtSYW5kb21HZW5lcmF0b3Iuc3RyaW5nKDgpfWA7XHJcbiAgICB9XHJcbiAgICBhY2NvdW50LmVycm9yTXNnID0gJ+ato+WcqOi/nuaOpeacjeWKoeWZqCc7XHJcbiAgICBhY2NvdW50LnNhdmUoKTtcclxuXHJcbiAgICBsZXQgcmVwb3J0ZXIgPSBuZXcgUmVwb3J0ZXIoR2xvYmFsQ29uZmlnLnJlcG9ydFNlcnZlci5ob3N0LCBHbG9iYWxDb25maWcucmVwb3J0U2VydmVyLnBvcnQsIGFjY291bnQucGVlcmlkLCBHbG9iYWxDb25maWcudmVyc2lvbik7XHJcblxyXG4gICAgbGV0IGxvZ2dlckZ1biA9IChpbmZvOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhpbmZvKTtcclxuICAgIH07XHJcbiAgICBsZXQgbG9nZ2VyOiBMb2dnZXIgPSBuZXcgTG9nZ2VyKGxvZ2dlckZ1biwgbG9nZ2VyRnVuLCBsb2dnZXJGdW4sIGxvZ0ZvbGRlcik7XHJcbiAgICBsZXQgZGV2aWNlSWRTYXZlID0gbmV3IExvY2FsU3RvcmFnZUpzb24oe1xyXG4gICAgICAgIGZpbGU6IHBhdGguam9pbihEaXJIZWxwZXIuZ2V0Q29uZmlnRGlyKCksICdkZXZpY2VJZC5qc29uJyksXHJcbiAgICAgICAgbG9nZ2VyXHJcbiAgICB9KTtcclxuICAgIGxldCBydW5uZXI6IFJ1bm5lciA9IG5ldyBSdW5uZXIoe1xyXG4gICAgICAgIGFjY291bnQsXHJcbiAgICAgICAgcmVwb3J0ZXIsXHJcbiAgICAgICAgdmVyc2lvbjogR2xvYmFsQ29uZmlnLnZlcnNpb24sXHJcbiAgICAgICAgdXBkYXRlSG9zdDogR2xvYmFsQ29uZmlnLnVwZGF0ZVNlcnZlci5ob3N0LFxyXG4gICAgICAgIHVwZGF0ZVBvcnQ6IEdsb2JhbENvbmZpZy51cGRhdGVTZXJ2ZXIucG9ydCxcclxuICAgICAgICBkZXZpY2VJZFNhdmUsXHJcbiAgICAgICAgcGxhdGZvcm06IG9zLnBsYXRmb3JtKCksXHJcbiAgICB9KTtcclxuICAgIGF3YWl0IHJ1bm5lci5zdGFydCgpO1xyXG4gICAgXHJcbiAgICAvLyBjb25zdCBzZXJ2aWNlaWQgPSBcIjQ0MDJcIjtcclxuICAgIC8vIGNvbnN0IHRhc2tMaXN0ID0gW1xyXG4gICAgLy8gICAgIFwiQ29ubmVjdF9GcmlzdFFBX1RDUF9kaXJlY3RcIixcclxuICAgIC8vICAgICBcIkNvbm5lY3RfRnJpc3RRQV9UQ1BfU05cIixcclxuICAgIC8vICAgICBcIkNvbm5lY3RfRnJpc3RRQV9UQ1BfUGFja2FnZVNpemVfYW5zd2VyXCIsXHJcbiAgICAvLyAgICAgXCJDb25uZWN0X0ZyaXN0UUFfVENQX1BhY2thZ2VTaXplX3F1ZXN5aW9uXCIsXHJcbiAgICAvLyAgICAgXCJDb25uZWN0X0ZyaXN0UUFfVURQX2RpcmVjdFwiLFxyXG4gICAgLy8gICAgIFwiQ29ubmVjdF9GcmlzdFFBX1VEUF9TTlwiLFxyXG4gICAgLy8gICAgIFwiQ29ubmVjdF9GcmlzdFFBX1VEUF9QYWNrYWdlU2l6ZV9hbnN3ZXJcIixcclxuICAgIC8vICAgICBcIkNvbm5lY3RfRnJpc3RRQV9VRFBfUGFja2FnZVNpemVfcXVlc3Rpb25cIixcclxuICAgIC8vIF1cclxuXHJcbiAgICBjb25zdCBzZXJ2aWNlaWQgPSBcIjU2NDE1MFwiO1xyXG4gICAgY29uc3QgdGFza0xpc3QgPSBbXHJcbiAgICAgICAgXCJETUNfZGVidWdlcl81MDBNQlwiLFxyXG4gICAgXTtcclxuICAgIGZvcihsZXQgaT0wO2k8MTAwMDA7aSsrKXtcclxuICAgICAgICB0YXNrTGlzdC5wdXNoKFwiRE1DX2RlYnVnZXJfNTAwTUJcIilcclxuICAgIH1cclxuICAgIGZvcihsZXQgaSBpbiB0YXNrTGlzdCl7XHJcbiAgICAgICAgbGV0IHJ1bkNvbmZpZyA9IHBhdGguam9pbihEaXJIZWxwZXIuZ2V0TG9nRGlyKCksXCJydW5uaW5nLnBpZFwiKVxyXG4gICAgICAgIGlmKCFmcy5leGlzdHNTeW5jKHJ1bkNvbmZpZykpe1xyXG4gICAgICAgICAgICBmcy5jcmVhdGVGaWxlU3luYyhydW5Db25maWcpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB0YXNraWQgPSB0YXNrTGlzdFtpXTtcclxuICAgICAgICBsZXQgc3RyID0gSlNPTi5zdHJpbmdpZnkoe3NlcnZpY2VpZCwgdGFza2lkfSk7XHJcbiAgICAgICAgcnVubmVyLnByb2Nlc3Muc2VuZChzdHIpO1xyXG4gICAgICAgIGF3YWl0IHJ1bm5lci5jaGVja19zdGF0ZSgpO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzcy5leGl0KDApO1xyXG59XHJcblxyXG5tYWluKCk7Il19
