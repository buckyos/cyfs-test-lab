# coding=utf-8

import os
import sys
import time
import json
import random
import redis
import pickle

from heartbeat import heartbeat
from peer_mgr import peerMgr

class nodeModules:
    def __init__(self):
        self._config = {}
        self._whitelist = {}
        self._configRefreshTime = 0

        self._logDate = ""
        self._logFile = None
        self._rootFolder = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

        logFolder = self._rootFolder + "/chainsdk_log/"
        if not os.path.exists(logFolder):
            os.mkdir(logFolder)
            
        self._onlinePeers = {}
        self._maxPeerCount = 0

    def getName(self):
        return "node_modules"

    def getConfig(self, peerinfo):
        if not peerinfo:
            return None

        self._loadConfig()
        whiteInfo = self._whitelist.get(peerinfo["peerid"], None)
        if whiteInfo == None:
            return None

        return self._config

    def onRequest(self, methodPath, body):
        if methodPath == 'queryCmd':
            return self.queryCmd(body)
        elif methodPath == 'crash':
            return self.onCrash(body)

    def peerPulse(self, peerid, body):
        now = time.time()
        lastUpdateTime = now
        peerinfo = self._onlinePeers.get(peerid, None)
        if peerinfo == None:
            peerinfo = {
                "peerid": peerid,
                "online": now,
            }
            self._onlinePeers[peerid] = peerinfo
        else:
            lastUpdateTime = peerinfo["updateTime"]

        peerinfo["updateTime"] = now
        peerinfo["version"] = body["version"];
        body["serverTime"] = now
        body["localTime"] = time.asctime(time.localtime(now))

        # remove timeout peers
        timeoutPeerids = []
        for peerid, peerinfo in self._onlinePeers.items():
            if now - peerinfo["updateTime"] > 1000:
                timeoutPeerids.append(peerid)

        for peerid in timeoutPeerids:
            self._onlinePeers.pop(peerid)

        # 记录peerid 心跳
        if now - lastUpdateTime > 120:
            heartbeat.recordHeartbeat(peerid, now)

        self._writeLog(body)
        self._loadConfig()

    def queryCmd(self, body):
        now = time.time()
        cmds = []
        peerid = body["peerid"]

        version = self._config["packageInfo"]["version"]
        if body["version"] != version:
            return cmds

        srcPeerinfo = self._onlinePeers.get(body["peerid"], None)
        if not srcPeerinfo:
            return cmds
        
        if ("online" in body["content"]):
            srcPeerinfo["online"] = now
            #print("online:peerid:%s, ip:%s, time:%d" % (peerid, body["ip"], now))

        onlinePeerCount = len(self._onlinePeers)
    
        ##### 下发测试指令？<TODO>

        return cmds

    def onCrash(self, body):
        peerid = body["peerid"]
        if peerid in self._onlinePeers:
            self._onlinePeers.pop(peerid)

    def _writeLog(self, body):
        logDate = time.strftime("%Y-%m-%d", time.localtime())
        if self._logDate != logDate:
            if self._logFile:
                self._logFile.close()
                
            self._logDate = logDate
            self._maxPeerCount = 0
            self._logPath = self._rootFolder + "/chainsdk_log/" + logDate + ".log"
            self._logFile = open(self._logPath, "a")

        if self._maxPeerCount < len(self._onlinePeers):
            self._maxPeerCount = len(self._onlinePeers)

        body["peercount"] = len(self._onlinePeers)
        body["maxPeerCount"] = self._maxPeerCount
        logTxt = json.dumps(body) + "\n\r"
        self._logFile.write(logTxt);

    def _loadConfig(self):
        now = time.time()
        if now - self._configRefreshTime > 3600:
            self._configRefreshTime = 0
            f = open(self._rootFolder + "/node_modules/config.json", "rb")
            if f:
                buf = f.read()
                f.close()
                if buf:
                    self._config = json.loads(buf.decode())
                    self._configRefreshTime = now

            f = open(self._rootFolder + "/node_modules/whitelist.json", "rb")
            if f:
                buf = f.read()
                f.close()
                if buf:
                    self._whitelist = json.loads(buf.decode())

nodemodules = nodeModules()
