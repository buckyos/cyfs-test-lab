# Stream 数据传输

## 测试用例设计

### 外部环境影响因素 

（1）IP层协议:
+ IPv4
+ IPv6
 
（2）运行机器操作系统
+ Win7/Win10/Win11/Windows server
+ Centos/Ubuntu/Debin
+ MacOS
+ IOS/Android

（3）网络链路影响因素

+ 网络延迟：当网络信息流过大时，可能导致设备反应缓慢，造成数据传输延迟；

+ 网路掉包：网路掉包是在数据传输的过程中，数据包由于各种原因在信道中丢失的现象；

+ 网络节流：当数据传输量达到网络带宽上限时，数据包可能会被设备拦截下来在之后发出；

+ 网络重发：当网络不稳定是可能会导致发送端判断数据包丢失导致部分数据包重发；

+ 数据乱序：当数据传输有可能出现数据包到达接收端时间不一致，导致数据包乱序问题；

+ 数据篡改：数据传输的过程中可能出现数据被连接篡改的情况；
  


### BDT 内部实现因素：

（1）Tunnel 类型：
+ TCP Tunnel
+ UDP Tunnel

（2）FristQA 实现

（3）拥塞控制算法

+ 慢启动：意思是刚刚加入网络的连接，一点一点地提速，不要一上来就把路占满。
+ 拥塞避免：当拥塞窗口 cwnd 达到一个阈值时，窗口大小不再呈指数上升，而是以线性上升，避免增长过快导致网络拥塞。
+ 快重传：在收到3个duplicate ACK时就开启重传，而不用等到RTO超时
+ 快速恢复：至少收到了3个Duplicated Acks，说明网络也不那么糟糕，可以快速恢复

网络链路是复杂的并且是动态变化的，链路有以下物理属性：

+ RTprop：光信号从A端到B端的最小时延（其实是2倍时延，因为是一个来回，但不影响讨论），这取决于物理距离
+ BtlBw：在A到B的链路中，它的带宽取决于最慢的那段链路的带宽，称为瓶颈带宽，可以想象为光纤的粗细
+ BtlBufSize：在A到B的链路中，每个路由器都有自己的缓存，这些缓存的容量之和，称为瓶颈缓存大小
+ BDP：整条物理链路（不含路由器缓存）所能储藏的比特数据之和，BDP = BtlBw * RTprop

链接的两个真实属性：

+ T（时延）：数据从A到B的实际时延，对应于图中的round-trip time（其实是单程的trip time，2倍即为RTT，不影响讨论）
+ R（带宽）：数据的实际传输带宽，对应于图中的delivery rate（并非严格对应，与T一样做了等效简化）

为了定量分析T与R，再引入一个概念：
+ D：已经从A发出但未被B收到的数据（对应于inflight data，我故意修改了它的原始定义——A已经发出但未收到B返回的ACK的数据——是为了直觉想象，不影响结论）

有了以上定义，很自然就有了以下3个式子：

+ T >= RTprop，即实际时延总是大于等于最小时延
+ R <= BtlBw，即实际带宽总是小于等于瓶颈带宽
+ R = D/T

由以上3式可得：

+ T/S >= 1/BtlBw
+ R/S <= 1/RTprop


（4）多路复用算法? 没有
    如果两个节点间存在多个可用链路，同时使用多个链路可以提高带宽

（5）连接迁移? 没有
    BDT协议栈所在设备网络发送变化时，Stream 流数据发送现在应该会发送失败

### FristQA测试用例

+ Stream_UDPTunnel_FristQA_OnePackage
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 发起建立连接过程连接带有FristQA的Sync数据包
    （2）RN 收到带有FristQA数据的请求后，ACK 包同时返回数据

预期结果：
    (1) 所有满足条件节点组合连接成功,连接过程中实现第一次FristQA数据发送
```


+ Stream_UDPTunnel_FristQA_1MData
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 发起建立连接过程连接带有FristQA的Sync数据包
    （2）RN 收到带有FristQA数据的请求后，ACK 包同时返回数据
     (3) LN 继续通过stream发送其他数据包，LN收到数据后和FristQA机制数据包合并
        
预期结果：
    (1) 所有满足条件节点组合连接成功,FristQA的数据包能成功和后续数据包发送一起使用
```

+ Stream_TCPTunnel_FristQA_OnePackage
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 发起建立连接过程连接带有FristQA的Sync数据包
    （2）RN 收到带有FristQA数据的请求后，ACK 包同时返回数据

预期结果：
    (1) 所有满足条件节点组合连接成功,连接过程中实现第一次FristQA数据发送
```

+ Stream_TCPTunnel_FristQA_1MData
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 发起建立连接过程连接带有FristQA的Sync数据包
    （2）RN 收到带有FristQA数据的请求后，ACK 包同时返回数据
     (3) LN 继续通过stream发送其他数据包，LN收到数据后和FristQA机制数据包合并
        
预期结果：
    (1) 所有满足条件节点组合连接成功,FristQA的数据包能成功和后续数据包发送一起使用
```

### Stream数据传输测试用例

#### 单个Stream数据发送性能
Rust 进行白盒测试：测试算法实现和理想状态传输的速率对比

算法在四种场景的性能：
+ 慢启动：意思是刚刚加入网络的连接，一点一点地提速，不要一上来就把路占满。
+ 拥塞避免：当拥塞窗口 cwnd 达到一个阈值时，窗口大小不再呈指数上升，而是以线性上升，避免增长过快导致网络拥塞。
+ 快重传：在收到3个duplicate ACK时就开启重传，而不用等到RTO超时
+ 快恢复：至少收到了3个Duplicated Acks，说明网络也不那么糟糕，可以快速恢复


#### 实验室Stream传输拥塞控制

覆盖测试场景：

+ 两个节点间多个连接持续单向发送数据
+ 两个节点间多个连接持续双向发送数据
+ 一个LN向多个RN建立连接持续发送数据
+ 多个LN向一个RN建立连接持续发送数据
+ 两个节点间持续发现小数据慢启动影响因素

BDT实现的两种底层协议：
+ TCP
+ UDP

+ Stream_TCPTunnel_10con_single_1MbData_10
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 和 RN 建立10个BDT连接，每个连接LN持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，Stream数据发送未产生拥塞
```

+ Stream_TCPTunnel_10con_both_1MbData
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 和 RN 建立10个BDT连接，每个连接LN/RN双向持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，Stream数据发送未产生拥塞
```


+ Stream_TCPTunnel_5RN_10con_1MbData
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 和 5个RN 建立10个BDT连接，每个连接LN/RN双向持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，LN Stream数据发送未产生拥塞
```

+ Stream_TCPTunnel_5LN_10con_1MbData
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）5个LN 和 RN 建立10个BDT连接，每个连接LN/RN双向持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，RN Stream数据接收未产生拥塞

```

+ Stream_TCPTunnel_1000_1kbData
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 和 RN 建立BDT连接，连续发送1000个1kb数据
预期结果：
    (1) 数据发送成功，RN Stream数据接收未产生拥塞
```


+ Stream_UDPTunnel_10con_single_1MbData_10
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 和 RN 建立10个BDT连接，每个连接LN持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，Stream数据发送未产生拥塞
```

+ Stream_UDPTunnel_10con_both_1MbData
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 和 RN 建立10个BDT连接，每个连接LN/RN双向持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，Stream数据发送未产生拥塞
```


+ Stream_UDPTunnel_5RN_10con_1MbData
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 和 5个RN 建立10个BDT连接，每个连接LN/RN双向持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，LN Stream数据发送未产生拥塞
```

+ Stream_UDPTunnel_5LN_10con_1MbData
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）5个LN 和 RN 建立10个BDT连接，每个连接LN/RN双向持续发送10*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功，RN Stream数据接收未产生拥塞

```

+ Stream_UDPTunnel_1000_1kbData
```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 和 RN 建立BDT连接，连续发送1000个1kb数据
预期结果：
    (1) 数据发送成功，RN Stream数据接收未产生拥塞
```

#### 实验室Stream传输网络链路因素拥塞控制

覆盖测试场景：
+ 网络带宽：10MbPs 、100MbPs、1000MbPs
+ 网络时延：+0ms、+10ms、+50ms、+100ms、200ms、500ms
+ 丢包率：0%、5%、10%、20%、50%

模拟线路
+ 线路1：网络带宽10MbPs、网络时延+0ms、丢包率0%
+ 线路2：网络带宽100MbPs、网络时延+0ms、丢包率0%
+ 线路3：网络带宽1000MbPs、网络时延+0ms、丢包率0%
+ 线路4：网络带宽1000MbPs、网络时延+10ms、丢包率0%
+ 线路5：网络带宽1000MbPs、网络时延+50ms、丢包率0%
+ 线路6：网络带宽1000MbPs、网络时延+100ms、丢包率0%
+ 线路7：网络带宽1000MbPs、网络时延+200ms、丢包率0%
+ 线路9：网络带宽1000MbPs、网络时延+200ms、丢包率0%
+ 线路10：网络带宽1000MbPs、网络时延+500ms、丢包率0%
+ 线路11：网络带宽100MbPs、网络时延+200ms、丢包率5%
+ 线路12：网络带宽100MbPs、网络时延+200ms、丢包率10%
+ 线路13：网络带宽100MbPs、网络时延+200ms、丢包率20%
+ 线路14：网络带宽100MbPs、网络时延+200ms、丢包率50%

测试用例操作

+ Stream_UDPTunnel_NetworkSimulate

```
前置条件：
    （1）LN/RN 网络可以基于UDP建立连接
操作步骤：
    （1）LN 和 RN 建立1个BDT连接，每个连接LN/RN双向持续发送100*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功
```
+ Stream_TCPTunnel_NetworkSimulate
```
前置条件：
    （1）LN/RN 网络可以基于TCP建立连接
操作步骤：
    （1）LN 和 RN 建立1个BDT连接，每个连接LN/RN双向持续发送100*1Mb 大小的字节流数据
预期结果：
    (1) 数据发送成功
```